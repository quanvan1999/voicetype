---
phase: 04-polish
plan: 03
type: execute
wave: 2
depends_on: [04-02]
files_modified:
  - LocalTranscript/LocalTranscript/Services/ModelManager.swift
  - LocalTranscript/LocalTranscript/Views/SettingsView.swift
  - LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
autonomous: true

must_haves:
  truths:
    - "User can see available model sizes in Settings"
    - "User can select a different model size"
    - "Download progress is shown during model download"
    - "Model switch unloads old model and loads new one"
    - "Selected model persists across app restart"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Services/ModelManager.swift"
      provides: "Model listing, download progress, switch capability"
      contains: "availableModels"
    - path: "LocalTranscript/LocalTranscript/Views/SettingsView.swift"
      provides: "Model picker with size/description"
      contains: "selectedModel"
  key_links:
    - from: "SettingsView.swift"
      to: "ModelManager"
      via: "onChange triggers switchModel"
      pattern: "modelManager.switchModel"
    - from: "ModelManager"
      to: "WhisperKit"
      via: "unload then reinitialize"
      pattern: "whisperKit = nil"
---

<objective>
Add model size selection (tiny/base/small/medium/large) with download progress

Purpose: Allow users to choose between speed (tiny) and accuracy (large) based on their hardware and needs
Output: Model picker in Settings, download progress UI, model switching capability
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish/04-RESEARCH.md

# Prior plan provides StatusIndicatorPanel
@.planning/phases/04-polish/04-02-SUMMARY.md

# Existing files to modify
@LocalTranscript/LocalTranscript/Services/ModelManager.swift
@LocalTranscript/LocalTranscript/Views/SettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance ModelManager with model selection and download progress</name>
  <files>
    LocalTranscript/LocalTranscript/Services/ModelManager.swift
  </files>
  <action>
    Modify ModelManager.swift:
    - Add static availableModels array of tuples: (id: String, name: String, size: String, description: String)
      - ("tiny", "Tiny", "~40MB", "Fastest, lower accuracy")
      - ("base", "Base", "~75MB", "Fast, decent accuracy")
      - ("small", "Small", "~250MB", "Balanced speed/accuracy")
      - ("medium", "Medium", "~750MB", "Better accuracy, slower")
      - ("large-v3", "Large", "~1.5GB", "Best accuracy, slowest")

    - Add @AppStorage("selectedModel") var selectedModel = "small"
    - Add @Published downloadProgress: Double = 0 (0.0 to 1.0)
    - Add @Published isDownloading = false

    - Modify loadModel() to use selectedModel instead of hardcoded "small"
    - Add download progress callback to WhisperKit initialization:
      ```swift
      let modelFolder = try await WhisperKit.download(
          variant: selectedModel,
          from: "argmaxinc/whisperkit-coreml",
          progressCallback: { progress in
              Task { @MainActor in
                  self.downloadProgress = progress.fractionCompleted
              }
          }
      )
      // Then initialize WhisperKit with the downloaded folder
      ```

    - Add switchModel(to model: String) async throws method:
      - Set selectedModel = model
      - Call unloadModel()
      - Call loadModel()

    - Add unloadModel() method (already exists, verify it sets whisperKit = nil)
  </action>
  <verify>
    Build succeeds: `cd LocalTranscript && xcodebuild -scheme LocalTranscript -configuration Debug build 2>&1 | grep -E "(BUILD|error:)"`
  </verify>
  <done>
    ModelManager can list available models, track download progress, and switch between models
  </done>
</task>

<task type="auto">
  <name>Task 2: Add model picker to Settings with download progress</name>
  <files>
    LocalTranscript/LocalTranscript/Views/SettingsView.swift
  </files>
  <action>
    Modify SettingsView.swift Model section:
    - Replace static "Whisper Small" text with Picker:
      ```swift
      Picker("Model Size", selection: $appState.modelManager.selectedModel) {
          ForEach(ModelManager.availableModels, id: \.id) { model in
              HStack {
                  Text(model.name)
                  Spacer()
                  Text(model.size)
                      .foregroundStyle(.secondary)
              }
              .tag(model.id)
          }
      }
      ```

    - Add onChange handler to trigger model switch:
      ```swift
      .onChange(of: appState.modelManager.selectedModel) { oldValue, newValue in
          guard oldValue != newValue else { return }
          Task {
              try? await appState.modelManager.switchModel(to: newValue)
          }
      }
      ```

    - Show download progress when isDownloading:
      ```swift
      if appState.modelManager.isDownloading {
          ProgressView(value: appState.modelManager.downloadProgress)
          Text("Downloading: \(Int(appState.modelManager.downloadProgress * 100))%")
              .font(.caption)
              .foregroundStyle(.secondary)
      }
      ```

    - Update description text to show selected model info
    - Disable picker while downloading or loading
  </action>
  <verify>
    Build succeeds and Settings shows model picker with all sizes
  </verify>
  <done>
    Settings has model picker showing all sizes with download progress during model switch
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire download progress to StatusIndicatorPanel</name>
  <files>
    LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  </files>
  <action>
    Modify TranscriptionService.swift startRecording():
    - When model needs loading, observe ModelManager.downloadProgress
    - Show StatusIndicatorPanel with .downloading(progress) state
    - Update progress as download progresses

    Implementation approach:
    - Check if !modelManager.isModelLoaded at start of startRecording()
    - If model needs loading:
      - Show statusPanel.updateState(.downloading(0))
      - Create observation task that watches modelManager.downloadProgress
      - Update panel: statusPanel.updateState(.downloading(modelManager.downloadProgress))
      - When loading completes, transition to .recording state

    Alternative simpler approach if observation is complex:
    - Add callback to ModelManager: var onDownloadProgress: ((Double) -> Void)?
    - In TranscriptionService, set the callback before loading
    - Update panel in callback
  </action>
  <verify>
    When switching to a new model size, floating indicator shows download progress
  </verify>
  <done>
    Download progress shown in status indicator during model download, both in Settings and during recording
  </done>
</task>

</tasks>

<verification>
- [ ] ModelManager.availableModels has 5 model sizes
- [ ] Settings shows model picker with all sizes
- [ ] Selecting different model triggers download (if not cached)
- [ ] Download progress shown in Settings (ProgressView)
- [ ] Download progress shown in StatusIndicatorPanel
- [ ] Selected model persists after app restart
- [ ] Model switch unloads old model before loading new
</verification>

<success_criteria>
- User can see all 5 model sizes in Settings picker
- User can select a different model and see download progress
- Download progress shown both in Settings and floating indicator
- Selected model persists across app restart
- Switching models properly unloads old model first
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish/04-03-SUMMARY.md`
</output>
