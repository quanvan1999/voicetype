---
phase: 04-polish
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - LocalTranscript/LocalTranscript/Views/SettingsView.swift
  - LocalTranscript/LocalTranscript/Services/ModelManager.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Selecting a different model triggers download and shows progress"
    - "History tab icon is visible in Settings toolbar"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Views/SettingsView.swift"
      provides: "Model picker bound to ModelManager, TabView with explicit tags"
    - path: "LocalTranscript/LocalTranscript/Services/ModelManager.swift"
      provides: "Model switch without race condition"
  key_links:
    - from: "SettingsView.swift model picker"
      to: "ModelManager.switchModel()"
      via: "onChange handler"
      pattern: "onChange.*switchModel"
---

<objective>
Fix UAT gaps: model download progress race condition and History tab icon not showing.

Purpose: Close verified UAT issues so Phase 4 can pass acceptance testing.
Output: Working model switching with progress display, visible History tab icon.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-polish/04-UAT.md
@LocalTranscript/LocalTranscript/Views/SettingsView.swift
@LocalTranscript/LocalTranscript/Services/ModelManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix model download race condition</name>
  <files>
    LocalTranscript/LocalTranscript/Views/SettingsView.swift
    LocalTranscript/LocalTranscript/Services/ModelManager.swift
  </files>
  <action>
The bug: @AppStorage("selectedModel") in SettingsView writes to UserDefaults immediately when picker changes. By the time onChange fires, ModelManager.selectedModel (which reads from same UserDefaults key) already has the new value. The guard clause `guard model != selectedModel` returns early.

Fix in SettingsView.swift:
1. Remove line 9: `@AppStorage("selectedModel") private var selectedModel = "small"`
2. Change model picker binding (line 71) from `$selectedModel` to a computed binding:
   ```swift
   Picker("Model Size", selection: Binding(
       get: { appState.modelManager.selectedModel },
       set: { newValue in
           Task {
               try? await appState.modelManager.switchModel(to: newValue)
           }
       }
   )) {
   ```
3. Remove the onChange(of: selectedModel) block (lines 83-88) since switching is now in the setter

Fix in ModelManager.swift:
1. Line 129: Change guard to only check if model is already loaded:
   `guard whisperKit == nil || model != selectedModel else { return }`
   This allows switching when model isn't loaded yet, but skips if same model is already loaded.

This removes the race condition entirely - the picker binding directly calls switchModel() without going through UserDefaults first.
  </action>
  <verify>
Build with `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -20`
  </verify>
  <done>
Model picker in Settings triggers switchModel() directly, no @AppStorage race condition. Selecting a new model starts download with progress visible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix History tab icon visibility</name>
  <files>LocalTranscript/LocalTranscript/Views/SettingsView.swift</files>
  <action>
The bug: macOS Settings scene with TabView using conditional @ViewBuilder in historyTab causes SwiftUI to fail rendering the toolbar tab item icon. The tab works (clicking invisible area switches tabs) but the icon/label doesn't render.

Fix in SettingsView.swift:
1. Add @State for tab selection at top of struct:
   `@State private var selectedTab = 0`

2. Add selection binding and explicit tags to TabView (around lines 12-22):
   ```swift
   TabView(selection: $selectedTab) {
       generalTab
           .tabItem {
               Label("General", systemImage: "gear")
           }
           .tag(0)

       historyTab
           .tabItem {
               Label("History", systemImage: "clock")
           }
           .tag(1)
   }
   ```

The explicit .tag() values combined with selection binding forces SwiftUI to properly render the toolbar items even with conditional content in the tab views.
  </action>
  <verify>
Build succeeds. The fix can be visually verified by user after build.
  </verify>
  <done>
History tab icon (clock) is visible in Settings toolbar alongside General tab icon (gear).
  </done>
</task>

</tasks>

<verification>
1. Build succeeds without warnings
2. Both files modified as specified
3. No @AppStorage("selectedModel") in SettingsView.swift
4. TabView has selection binding and .tag() on both tabs
</verification>

<success_criteria>
- Model picker triggers switchModel() directly via binding setter
- No race condition between UI and ModelManager
- History tab icon visible in Settings toolbar
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish/04-05-SUMMARY.md`
</output>
