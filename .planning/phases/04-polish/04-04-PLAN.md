---
phase: 04-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - LocalTranscript/LocalTranscript/Models/TranscriptionRecord.swift
  - LocalTranscript/LocalTranscript/Services/HistoryManager.swift
  - LocalTranscript/LocalTranscript/Views/HistoryView.swift
  - LocalTranscript/LocalTranscript/LocalTranscriptApp.swift
  - LocalTranscript/LocalTranscript/Views/SettingsView.swift
  - LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
autonomous: true

must_haves:
  truths:
    - "User can see list of recent transcriptions"
    - "User can copy text from any history item"
    - "User can delete history items"
    - "History persists across app restart"
    - "New transcriptions automatically appear in history"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Models/TranscriptionRecord.swift"
      provides: "SwiftData @Model for transcription storage"
      contains: "@Model"
    - path: "LocalTranscript/LocalTranscript/Services/HistoryManager.swift"
      provides: "SwiftData container and save/delete operations"
      contains: "ModelContainer"
    - path: "LocalTranscript/LocalTranscript/Views/HistoryView.swift"
      provides: "List view with copy/delete actions"
      contains: "@Query"
  key_links:
    - from: "TranscriptionService.swift"
      to: "HistoryManager"
      via: "Save transcription after completion"
      pattern: "historyManager.save"
    - from: "HistoryView.swift"
      to: "TranscriptionRecord"
      via: "@Query fetches records"
      pattern: "@Query.*TranscriptionRecord"
---

<objective>
Add transcription history storage and viewing using SwiftData

Purpose: User can review and copy past transcriptions without re-recording
Output: TranscriptionRecord model, HistoryManager service, HistoryView UI, auto-save integration
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish/04-RESEARCH.md

# Existing files to modify
@LocalTranscript/LocalTranscript/LocalTranscriptApp.swift
@LocalTranscript/LocalTranscript/Views/SettingsView.swift
@LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SwiftData model and HistoryManager</name>
  <files>
    LocalTranscript/LocalTranscript/Models/TranscriptionRecord.swift
    LocalTranscript/LocalTranscript/Services/HistoryManager.swift
  </files>
  <action>
    Create TranscriptionRecord.swift:
    ```swift
    import Foundation
    import SwiftData

    @Model
    final class TranscriptionRecord {
        var id: UUID
        var text: String
        var timestamp: Date
        var languageMode: String
        var duration: TimeInterval  // Recording duration in seconds

        init(text: String, languageMode: String, duration: TimeInterval) {
            self.id = UUID()
            self.text = text
            self.timestamp = Date()
            self.languageMode = languageMode
            self.duration = duration
        }
    }
    ```

    Create HistoryManager.swift:
    ```swift
    import Foundation
    import SwiftData

    @Observable
    class HistoryManager {
        private var modelContainer: ModelContainer?
        private var modelContext: ModelContext?

        init() {
            setupContainer()
        }

        private func setupContainer() {
            do {
                let schema = Schema([TranscriptionRecord.self])
                let appSupportURL = FileManager.default.urls(for: .applicationSupportDirectory, in: .userDomainMask)[0]
                    .appendingPathComponent("LocalTranscript", isDirectory: true)

                // Create directory if needed
                try FileManager.default.createDirectory(at: appSupportURL, withIntermediateDirectories: true)

                let storeURL = appSupportURL.appendingPathComponent("history.store")
                let config = ModelConfiguration("LocalTranscript", schema: schema, url: storeURL)
                modelContainer = try ModelContainer(for: schema, configurations: config)
                modelContext = ModelContext(modelContainer!)
            } catch {
                print("Failed to setup SwiftData: \(error)")
            }
        }

        var container: ModelContainer? { modelContainer }

        func save(text: String, languageMode: String, duration: TimeInterval) {
            guard let context = modelContext else { return }
            let record = TranscriptionRecord(text: text, languageMode: languageMode, duration: duration)
            context.insert(record)
            try? context.save()

            // Keep only last 100 records
            pruneOldRecords()
        }

        func delete(_ record: TranscriptionRecord) {
            guard let context = modelContext else { return }
            context.delete(record)
            try? context.save()
        }

        func clearAll() {
            guard let context = modelContext else { return }
            do {
                try context.delete(model: TranscriptionRecord.self)
                try context.save()
            } catch {
                print("Failed to clear history: \(error)")
            }
        }

        private func pruneOldRecords() {
            guard let context = modelContext else { return }
            let descriptor = FetchDescriptor<TranscriptionRecord>(
                sortBy: [SortDescriptor(\.timestamp, order: .reverse)]
            )
            do {
                let records = try context.fetch(descriptor)
                if records.count > 100 {
                    for record in records.dropFirst(100) {
                        context.delete(record)
                    }
                    try context.save()
                }
            } catch {
                print("Failed to prune records: \(error)")
            }
        }
    }
    ```
  </action>
  <verify>
    Build succeeds: `cd LocalTranscript && xcodebuild -scheme LocalTranscript -configuration Debug build 2>&1 | grep -E "(BUILD|error:)"`
  </verify>
  <done>
    TranscriptionRecord @Model exists, HistoryManager can save/delete/clear records with 100-item limit
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HistoryView and add to Settings</name>
  <files>
    LocalTranscript/LocalTranscript/Views/HistoryView.swift
    LocalTranscript/LocalTranscript/Views/SettingsView.swift
    LocalTranscript/LocalTranscript/Models/AppState.swift
  </files>
  <action>
    Modify AppState.swift:
    - Add: let historyManager = HistoryManager()

    Create HistoryView.swift:
    ```swift
    import SwiftUI
    import SwiftData

    struct HistoryView: View {
        @Query(sort: \TranscriptionRecord.timestamp, order: .reverse)
        private var records: [TranscriptionRecord]
        @Environment(\.modelContext) private var modelContext
        @Environment(AppState.self) private var appState

        var body: some View {
            Group {
                if records.isEmpty {
                    ContentUnavailableView(
                        "No Transcriptions",
                        systemImage: "text.bubble",
                        description: Text("Your transcription history will appear here")
                    )
                } else {
                    List {
                        ForEach(records) { record in
                            HistoryRow(record: record)
                        }
                        .onDelete(perform: deleteRecords)
                    }
                }
            }
            .toolbar {
                if !records.isEmpty {
                    ToolbarItem {
                        Button("Clear All", role: .destructive) {
                            appState.historyManager.clearAll()
                        }
                    }
                }
            }
        }

        private func deleteRecords(at offsets: IndexSet) {
            for index in offsets {
                modelContext.delete(records[index])
            }
        }
    }

    struct HistoryRow: View {
        let record: TranscriptionRecord
        @State private var isCopied = false

        var body: some View {
            VStack(alignment: .leading, spacing: 4) {
                Text(record.text)
                    .lineLimit(3)

                HStack {
                    Text(record.timestamp, style: .relative)
                    Text("*")
                    Text(record.languageMode)
                    if record.duration > 0 {
                        Text("*")
                        Text(String(format: "%.1fs", record.duration))
                    }
                }
                .font(.caption)
                .foregroundStyle(.secondary)
            }
            .contextMenu {
                Button {
                    NSPasteboard.general.clearContents()
                    NSPasteboard.general.setString(record.text, forType: .string)
                    isCopied = true
                    DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
                        isCopied = false
                    }
                } label: {
                    Label(isCopied ? "Copied!" : "Copy", systemImage: "doc.on.doc")
                }
            }
            .padding(.vertical, 4)
        }
    }
    ```

    Modify SettingsView.swift:
    - Add TabView with tabs: "General", "History"
    - Move existing Form content to "General" tab
    - Add HistoryView in "History" tab
    - Wrap HistoryView with modelContainer from appState.historyManager.container
    - Increase frame height to accommodate tabs (height: 550)
  </action>
  <verify>
    Build succeeds and Settings window shows History tab with empty state
  </verify>
  <done>
    HistoryView shows transcription records with copy/delete, accessible from Settings tab
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire TranscriptionService to save history</name>
  <files>
    LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
    LocalTranscript/LocalTranscript/Models/AppState.swift
  </files>
  <action>
    Modify TranscriptionService.swift:
    - Add private var historyManager: HistoryManager?
    - Add private var recordingStartTime: Date?
    - Modify init() to accept historyManager parameter:
      ```swift
      init(audioRecorder: AudioRecorder, modelManager: ModelManager, historyManager: HistoryManager? = nil)
      ```

    - In startRecording(): recordingStartTime = Date()

    - In stopRecording(), after successful transcription (state = .completed(text)):
      ```swift
      // Save to history
      if let historyManager = historyManager, let startTime = recordingStartTime {
          let duration = Date().timeIntervalSince(startTime)
          let languageMode = LanguageMode(rawValue: self.languageMode) ?? .auto
          historyManager.save(text: text, languageMode: languageMode.rawValue, duration: duration)
      }
      ```

    Modify AppState.swift transcriptionService computed property:
    - Pass historyManager to TranscriptionService init:
      ```swift
      let service = TranscriptionService(
          audioRecorder: audioRecorder,
          modelManager: modelManager,
          historyManager: historyManager
      )
      ```
  </action>
  <verify>
    After recording and transcribing, new entry appears in History tab
  </verify>
  <done>
    Transcriptions automatically saved to history with timestamp, language mode, and duration
  </done>
</task>

</tasks>

<verification>
- [ ] TranscriptionRecord @Model compiles with SwiftData
- [ ] HistoryManager creates container at app-specific location
- [ ] HistoryView shows records with @Query
- [ ] Copy context menu works (copies to clipboard)
- [ ] Delete via swipe or context menu works
- [ ] Clear All button removes all records
- [ ] New transcriptions appear in history automatically
- [ ] History persists after app restart
- [ ] History limited to 100 items (old ones pruned)
</verification>

<success_criteria>
- User can view history of past transcriptions in Settings > History tab
- User can copy any transcription text to clipboard
- User can delete individual history items
- User can clear all history
- New transcriptions automatically saved with timestamp, language, duration
- History persists across app restart
- History auto-prunes to 100 items
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish/04-04-SUMMARY.md`
</output>
