---
phase: 04-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - LocalTranscript/LocalTranscript/Views/StatusIndicatorPanel.swift
  - LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  - LocalTranscript/LocalTranscript/Models/StatusIndicatorState.swift
autonomous: true

must_haves:
  truths:
    - "User sees visual indicator when recording"
    - "User sees visual indicator when transcribing"
    - "User sees visual indicator when model is downloading"
    - "User sees error message when transcription fails"
    - "Indicators auto-dismiss appropriately"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Models/StatusIndicatorState.swift"
      provides: "StatusIndicatorState enum with all states"
      contains: "enum StatusIndicatorState"
    - path: "LocalTranscript/LocalTranscript/Views/StatusIndicatorPanel.swift"
      provides: "Enhanced floating panel with multiple states"
      contains: "updateState"
  key_links:
    - from: "TranscriptionService.swift"
      to: "StatusIndicatorPanel"
      via: "updateState calls for each state transition"
      pattern: "statusPanel.updateState"
    - from: "StatusIndicatorPanel"
      to: "StatusIndicatorState"
      via: "switch on state to render different visuals"
      pattern: "switch state"
---

<objective>
Add status feedback UI for all blocking states (recording, transcribing, downloading, error)

Purpose: User knows what the app is doing at all times, especially during slow operations like model download
Output: StatusIndicatorState enum, enhanced StatusIndicatorPanel, integration with TranscriptionService
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish/04-RESEARCH.md

# Existing files to modify/reference
@LocalTranscript/LocalTranscript/Views/FloatingIndicatorPanel.swift
@LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
@LocalTranscript/LocalTranscript/Services/ModelManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatusIndicatorState and enhanced StatusIndicatorPanel</name>
  <files>
    LocalTranscript/LocalTranscript/Models/StatusIndicatorState.swift
    LocalTranscript/LocalTranscript/Views/StatusIndicatorPanel.swift
  </files>
  <action>
    Create StatusIndicatorState.swift:
    - enum StatusIndicatorState with cases:
      - recording
      - transcribing
      - downloading(progress: Double)
      - error(message: String)
      - languageChanged(String) // For language mode feedback

    Replace FloatingIndicatorPanel.swift with StatusIndicatorPanel.swift:
    - Keep same NSPanel setup (borderless, floating, canJoinAllSpaces, fullScreenAuxiliary)
    - Add private properties: iconView (NSImageView), textLabel (NSTextField), progressBar (NSProgressIndicator)
    - Add updateState(_ state: StatusIndicatorState) method that:
      - For .recording: red circle icon, "Recording" text
      - For .transcribing: blue waveform icon (SF Symbol), "Transcribing..." text
      - For .downloading(progress): orange download icon, "Downloading: X%" text, show progress bar
      - For .error(message): red exclamation icon, message text, auto-hide after 3s
      - For .languageChanged(mode): green globe icon, mode name text, auto-hide after 1.5s
    - Use SF Symbols via NSImage(systemSymbolName:accessibilityDescription:)
    - Keep panel size adaptive based on content (width: 140-200, height: 36-50)
    - Delete old FloatingIndicatorPanel.swift after creating StatusIndicatorPanel.swift
  </action>
  <verify>
    Build succeeds: `cd LocalTranscript && xcodebuild -scheme LocalTranscript -configuration Debug build 2>&1 | grep -E "(BUILD|error:)"`
  </verify>
  <done>
    StatusIndicatorState enum exists, StatusIndicatorPanel can render all states with appropriate icons and text
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire StatusIndicatorPanel to TranscriptionService</name>
  <files>
    LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  </files>
  <action>
    Modify TranscriptionService.swift:
    - Change floatingPanel type from FloatingIndicatorPanel to StatusIndicatorPanel
    - In startRecording():
      - Before starting, check if model needs loading and show .downloading(0) state
      - After model loads, show .recording state
    - In stopRecording():
      - Show .transcribing state before transcribe() call
      - On success, hide panel
      - On error, show .error(error.localizedDescription) state
    - Add showLanguageChanged(_ mode: String) method for Plan 01's hotkey to call
    - Update showFloatingIndicator() to showStatusIndicator(_ state:)
    - Update hideFloatingIndicator() to hideStatusIndicator()

    Wire to ModelManager for download progress:
    - If ModelManager.isLoading is true, show downloading state
    - For now, ModelManager doesn't have progress callbacks, so show indeterminate "Downloading..."
    - (Plan 03 will add proper progress to ModelManager)
  </action>
  <verify>
    Build succeeds and app shows different indicator states during recording flow
  </verify>
  <done>
    TranscriptionService shows appropriate status indicator for each state (recording, transcribing, error)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add language change feedback integration</name>
  <files>
    LocalTranscript/LocalTranscript/Services/HotkeyService.swift
    LocalTranscript/LocalTranscript/Models/AppState.swift
  </files>
  <action>
    This task integrates with Plan 01's language hotkey. If Plan 01 runs first, this adds visual feedback.
    If Plan 02 runs first, Plan 01 will use the status indicator.

    Modify AppState.swift:
    - Add method showLanguageFeedback(_ mode: String) that calls transcriptionService.showLanguageChanged(mode)

    Modify HotkeyService.swift (if Plan 01 already added cycleLanguageMode):
    - After cycling language mode, need to show feedback via AppState
    - Add optional callback: var onLanguageChanged: ((String) -> Void)?
    - In cycleLanguageMode(), call onLanguageChanged?(newMode.rawValue)

    Modify AppState.swift init():
    - Set hotkeyService.onLanguageChanged = { [weak self] mode in self?.showLanguageFeedback(mode) }

    If Plan 01 hasn't run yet, just prepare the integration point in TranscriptionService.
  </action>
  <verify>
    Build succeeds and pressing language hotkey shows brief indicator (if Plan 01 ran first)
  </verify>
  <done>
    Language mode change shows brief visual feedback via StatusIndicatorPanel
  </done>
</task>

</tasks>

<verification>
- [ ] StatusIndicatorState enum exists with all states
- [ ] StatusIndicatorPanel renders correctly for each state
- [ ] Recording shows red "Recording" indicator
- [ ] Transcribing shows blue "Transcribing..." indicator
- [ ] Errors show red error message with auto-dismiss
- [ ] Language changes show brief feedback with auto-dismiss
</verification>

<success_criteria>
- User sees appropriate visual feedback for all app states
- Recording state shows red indicator
- Transcribing state shows blue indicator
- Error states show error message briefly
- Language change shows brief confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish/04-02-SUMMARY.md`
</output>
