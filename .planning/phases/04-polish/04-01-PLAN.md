---
phase: 04-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - LocalTranscript/LocalTranscript/Models/LanguageMode.swift
  - LocalTranscript/LocalTranscript/Services/HotkeyService.swift
  - LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  - LocalTranscript/LocalTranscript/Views/SettingsView.swift
autonomous: true

must_haves:
  truths:
    - "User can see current language mode in Settings"
    - "User can change language mode via picker"
    - "User can cycle language mode with hotkey"
    - "Language mode persists across app restart"
    - "Transcription uses selected language mode"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Models/LanguageMode.swift"
      provides: "LanguageMode enum with whisper language codes"
      contains: "enum LanguageMode"
    - path: "LocalTranscript/LocalTranscript/Services/HotkeyService.swift"
      provides: "cycleLanguage hotkey registration"
      contains: "cycleLanguage"
    - path: "LocalTranscript/LocalTranscript/Services/TranscriptionService.swift"
      provides: "Language mode in DecodingOptions"
      contains: "languageMode"
  key_links:
    - from: "TranscriptionService.swift"
      to: "LanguageMode"
      via: "AppStorage languageMode used in DecodingOptions"
      pattern: "languageMode.whisperLanguageCode"
    - from: "HotkeyService.swift"
      to: "LanguageMode"
      via: "cycleLanguage hotkey cycles through modes"
      pattern: "KeyboardShortcuts.Name.cycleLanguage"
---

<objective>
Add language mode selection (Auto/Vietnamese/English) with hotkey cycling

Purpose: Allow users to force specific language recognition or use auto-detect, with quick switching via hotkey
Output: LanguageMode enum, Settings picker, cycleLanguage hotkey, TranscriptionService integration
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish/04-RESEARCH.md

# Existing files to modify
@LocalTranscript/LocalTranscript/Services/HotkeyService.swift
@LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
@LocalTranscript/LocalTranscript/Views/SettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LanguageMode enum and add to TranscriptionService</name>
  <files>
    LocalTranscript/LocalTranscript/Models/LanguageMode.swift
    LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  </files>
  <action>
    Create LanguageMode.swift with:
    - enum LanguageMode: String, CaseIterable with cases auto, vietnamese, english
    - Computed property whisperLanguageCode: String? returning nil for auto, "vi" for vietnamese, "en" for english
    - rawValue strings: "Auto", "Vietnamese", "English" for display

    Modify TranscriptionService.swift:
    - Add @AppStorage("languageMode") private var languageMode = LanguageMode.auto.rawValue
    - In transcribe() method, replace hardcoded language: nil with:
      - Parse languageMode string to LanguageMode enum
      - Use languageMode.whisperLanguageCode in DecodingOptions
    - Import SwiftUI for @AppStorage
  </action>
  <verify>
    Build succeeds: `cd LocalTranscript && xcodebuild -scheme LocalTranscript -configuration Debug build 2>&1 | grep -E "(BUILD|error:)"`
  </verify>
  <done>
    LanguageMode enum exists with three cases, TranscriptionService uses @AppStorage languageMode in DecodingOptions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add language mode picker to Settings and cycleLanguage hotkey</name>
  <files>
    LocalTranscript/LocalTranscript/Views/SettingsView.swift
    LocalTranscript/LocalTranscript/Services/HotkeyService.swift
  </files>
  <action>
    Modify HotkeyService.swift:
    - Add KeyboardShortcuts.Name.cycleLanguage with default Option+L: .init(.l, modifiers: [.option])
    - Add @AppStorage("languageMode") private var languageMode = LanguageMode.auto.rawValue
    - Add cycleLanguageMode() method that cycles Auto -> Vietnamese -> English -> Auto
    - In init(), register KeyboardShortcuts.onKeyUp(for: .cycleLanguage) that calls cycleLanguageMode()
    - After cycling, briefly show visual feedback (we'll add status indicator in plan 03, for now just print)

    Modify SettingsView.swift:
    - Add @AppStorage("languageMode") private var languageMode = LanguageMode.auto.rawValue
    - Add Language section after Hotkey section with:
      - Picker "Language Mode" with segmented style, binding to languageMode
      - ForEach over LanguageMode.allCases, using mode.rawValue for both Text and tag
      - KeyboardShortcuts.Recorder for cycleLanguage hotkey
      - Help text: "Auto-detect or force specific language. Cycle with hotkey."
  </action>
  <verify>
    Build succeeds and Settings window shows Language section with picker and hotkey recorder
  </verify>
  <done>
    Language picker in Settings with three options, Option+L cycles through language modes
  </done>
</task>

<task type="auto">
  <name>Task 3: Test language mode persistence and transcription</name>
  <files>None (testing only)</files>
  <action>
    Manual verification steps:
    1. Build and run the app
    2. Open Settings, verify Language section appears with picker
    3. Change language mode to Vietnamese, quit and relaunch app
    4. Verify language mode is still Vietnamese in Settings
    5. Press Option+L to cycle language, verify it cycles to English
    6. Record short speech with Vietnamese selected, verify transcription uses Vietnamese mode (check console output)

    If any step fails, debug and fix the issue.
  </action>
  <verify>
    - Language mode persists across app restart
    - Option+L cycles through language modes
    - Console shows language mode being used in transcription
  </verify>
  <done>
    Language mode selection fully functional with persistence, hotkey cycling, and transcription integration
  </done>
</task>

</tasks>

<verification>
- [ ] LanguageMode.swift exists with auto/vietnamese/english cases
- [ ] TranscriptionService reads language mode from @AppStorage
- [ ] DecodingOptions uses languageMode.whisperLanguageCode
- [ ] Settings has Language section with segmented picker
- [ ] Option+L hotkey registered for language cycling
- [ ] Language mode persists after app restart
</verification>

<success_criteria>
- User can select language mode in Settings (Auto/Vietnamese/English)
- User can cycle language mode with Option+L hotkey
- Language mode persists across app restart
- Transcription uses selected language mode in DecodingOptions
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish/04-01-SUMMARY.md`
</output>
