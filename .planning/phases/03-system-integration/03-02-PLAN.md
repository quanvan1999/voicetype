---
phase: 03-system-integration
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - LocalTranscript/LocalTranscript/Models/AppState.swift
  - LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  - LocalTranscript/LocalTranscript/Views/SettingsView.swift
autonomous: false

must_haves:
  truths:
    - "Global hotkey triggers recording start/stop"
    - "Transcribed text is automatically inserted at cursor"
    - "User can configure hotkey in Settings"
    - "User can choose between hold-to-talk and toggle modes"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Models/AppState.swift"
      provides: "HotkeyService integration"
      contains: "hotkeyService"
    - path: "LocalTranscript/LocalTranscript/Services/TranscriptionService.swift"
      provides: "Auto-insert on completion"
      contains: "textInsertionService"
    - path: "LocalTranscript/LocalTranscript/Views/SettingsView.swift"
      provides: "Hotkey recorder and mode picker"
      contains: "KeyboardShortcuts.Recorder"
  key_links:
    - from: "AppState.swift"
      to: "HotkeyService.swift"
      via: "bind() with TranscriptionService methods"
      pattern: "hotkeyService\\.bind"
    - from: "TranscriptionService.swift"
      to: "TextInsertionService.swift"
      via: "insertText on completion"
      pattern: "textInsertionService\\.insertText"
    - from: "SettingsView.swift"
      to: "KeyboardShortcuts.Recorder"
      via: "SwiftUI integration"
      pattern: "KeyboardShortcuts\\.Recorder"
---

<objective>
Wire HotkeyService and TextInsertionService into the app, and add Settings UI for hotkey configuration.

Purpose: Complete the user flow - hotkey triggers recording, transcription result is auto-inserted at cursor.
Output: Fully functional global hotkey with text insertion and user-configurable settings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-system-integration/03-RESEARCH.md
@.planning/phases/03-system-integration/03-01-SUMMARY.md

# Files to modify
@LocalTranscript/LocalTranscript/Models/AppState.swift
@LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
@LocalTranscript/LocalTranscript/Views/SettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire HotkeyService to AppState and TranscriptionService</name>
  <files>
    LocalTranscript/LocalTranscript/Models/AppState.swift
  </files>
  <action>
Update AppState.swift to add HotkeyService and wire it to TranscriptionService:

```swift
import SwiftUI

@Observable
class AppState {
    let permissionManager = PermissionManager()
    let modelManager = ModelManager()
    let launchManager = LaunchManager()
    let audioRecorder = AudioRecorder()
    let hotkeyService = HotkeyService()

    @ObservationIgnored
    private var _transcriptionService: TranscriptionService?

    var transcriptionService: TranscriptionService {
        if let service = _transcriptionService {
            return service
        }
        let service = TranscriptionService(audioRecorder: audioRecorder, modelManager: modelManager)
        _transcriptionService = service
        return service
    }

    var isRecording: Bool {
        transcriptionService.isRecording
    }

    init() {
        setupHotkeyBindings()
    }

    private func setupHotkeyBindings() {
        hotkeyService.bind(
            onStart: { [weak self] in
                guard let self else { return }
                try await self.transcriptionService.startRecording()
            },
            onStop: { [weak self] in
                guard let self else { return }
                await self.transcriptionService.stopRecording()
            }
        )
    }
}
```

Key changes:
- Add `hotkeyService = HotkeyService()` property
- Add init() method with setupHotkeyBindings()
- Bind hotkey callbacks to transcriptionService start/stop methods
- Use [weak self] to prevent retain cycles
  </action>
  <verify>
1. Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript build`
2. HotkeyService added: grep "hotkeyService" AppState.swift
3. Bindings set up: grep "setupHotkeyBindings" AppState.swift
  </verify>
  <done>
- AppState has hotkeyService property
- Hotkey callbacks bound to TranscriptionService start/stop
- init() calls setupHotkeyBindings()
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire TextInsertionService to TranscriptionService</name>
  <files>
    LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  </files>
  <action>
Update TranscriptionService.swift to auto-insert text on completion:

1. Add TextInsertionService dependency:
```swift
private let textInsertionService = TextInsertionService()
```

2. Add optional callback for text output (for flexibility):
```swift
var onTranscriptionComplete: ((String) -> Void)?
```

3. In stopRecording(), after transcription completes successfully, insert text:
```swift
// After: state = .completed(text)
// Add:
// Auto-insert text at cursor
Task {
    do {
        try await textInsertionService.insertText(text)
        logger.info("Text inserted at cursor")
    } catch {
        logger.error("Text insertion failed: \(error)")
        // Text is still on clipboard from insertViaClipboard, user can paste manually
    }
}
```

The full stopRecording() method should look like:
```swift
@MainActor
func stopRecording() async {
    print("[StopRecording] Called, state = \(state)")
    guard case .recording = state else {
        print("[StopRecording] Not recording, returning")
        return
    }

    // Stop recording and get samples
    let samples = audioRecorder.stopRecording()
    print("[StopRecording] Got \(samples.count) samples (\(Double(samples.count) / 16000.0) seconds)")

    // Hide floating indicator
    hideFloatingIndicator()

    // Play stop sound
    AudioFeedback.playStopSound()

    guard !samples.isEmpty else {
        logger.error("No audio captured")
        state = .error(TranscriptionError.noAudioCaptured)
        return
    }

    // Transcribe
    state = .transcribing
    logger.info("Starting transcription...")

    do {
        let text = try await transcribe(samples: samples)
        logger.info("Transcription result: '\(text)'")
        lastTranscription = text
        state = .completed(text)

        // Auto-insert text at cursor
        do {
            try await textInsertionService.insertText(text)
            logger.info("Text inserted at cursor")
        } catch {
            logger.error("Text insertion failed: \(error)")
            // Text is still on clipboard, user can paste manually
        }
    } catch {
        logger.error("Transcription error: \(error)")
        state = .error(error)
    }
}
```

Key implementation details:
- TextInsertionService created as property (no need for injection, it's stateless)
- Text insertion happens after state = .completed (UI updates first)
- Insertion failure logged but doesn't affect transcription success
- User can always paste manually if insertion fails (text is on clipboard)
  </action>
  <verify>
1. Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript build`
2. TextInsertionService added: grep "textInsertionService" TranscriptionService.swift
3. insertText called: grep "insertText" TranscriptionService.swift
  </verify>
  <done>
- TranscriptionService has textInsertionService property
- Text auto-inserted after successful transcription
- Insertion failure doesn't break transcription flow
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Hotkey Settings to SettingsView</name>
  <files>
    LocalTranscript/LocalTranscript/Views/SettingsView.swift
  </files>
  <action>
Update SettingsView.swift to add hotkey configuration:

1. Add import at top:
```swift
import KeyboardShortcuts
```

2. Add new Section for Hotkey (after General section):
```swift
Section("Hotkey") {
    KeyboardShortcuts.Recorder("Recording Shortcut:", name: .toggleRecording)

    @Bindable var hotkeyService = appState.hotkeyService
    Picker("Mode", selection: $hotkeyService.mode) {
        ForEach(RecordingMode.allCases, id: \.self) { mode in
            Text(mode.rawValue).tag(mode)
        }
    }
    .pickerStyle(.segmented)

    Text(hotkeyDescription)
        .font(.caption)
        .foregroundStyle(.secondary)
}
```

3. Add computed property for description:
```swift
private var hotkeyDescription: String {
    switch appState.hotkeyService.mode {
    case .holdToTalk:
        return "Hold the shortcut to record, release to transcribe and insert"
    case .toggle:
        return "Press once to start recording, press again to stop and insert"
    }
}
```

4. Update Permissions section - change Accessibility description:
```swift
PermissionRow(
    title: "Accessibility",
    description: "Required for text insertion and global hotkey",  // Updated text
    isGranted: accessibilityGranted,
    ...
)
```

Full updated SettingsView should look like:
```swift
import SwiftUI
import KeyboardShortcuts

struct SettingsView: View {
    @Environment(AppState.self) var appState
    @State private var micStatus: PermissionManager.MicrophoneStatus = .notDetermined
    @State private var accessibilityGranted = false

    var body: some View {
        Form {
            Section("General") {
                @Bindable var launchManager = appState.launchManager
                Toggle("Start at Login", isOn: $launchManager.launchAtLogin)
                    .onAppear {
                        appState.launchManager.syncFromSystem()
                    }
            }

            Section("Hotkey") {
                KeyboardShortcuts.Recorder("Recording Shortcut:", name: .toggleRecording)

                @Bindable var hotkeyService = appState.hotkeyService
                Picker("Mode", selection: $hotkeyService.mode) {
                    ForEach(RecordingMode.allCases, id: \.self) { mode in
                        Text(mode.rawValue).tag(mode)
                    }
                }
                .pickerStyle(.segmented)

                Text(hotkeyDescription)
                    .font(.caption)
                    .foregroundStyle(.secondary)
            }

            Section("Model") {
                // ... existing model section unchanged
            }

            Section("Permissions") {
                // ... existing permissions section with updated Accessibility description
            }
        }
        // ... rest unchanged
    }

    private var hotkeyDescription: String {
        switch appState.hotkeyService.mode {
        case .holdToTalk:
            return "Hold the shortcut to record, release to transcribe and insert"
        case .toggle:
            return "Press once to start recording, press again to stop and insert"
        }
    }
}
```
  </action>
  <verify>
1. Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript build`
2. KeyboardShortcuts imported: grep "import KeyboardShortcuts" SettingsView.swift
3. Recorder present: grep "KeyboardShortcuts.Recorder" SettingsView.swift
4. Mode picker present: grep "RecordingMode" SettingsView.swift
  </verify>
  <done>
- SettingsView has Hotkey section
- KeyboardShortcuts.Recorder for custom shortcut
- Mode picker (Hold to Talk / Toggle)
- Description text explains each mode
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete global hotkey and text insertion system</what-built>
  <how-to-verify>
1. Open app, go to Settings
2. Verify "Hotkey" section appears with:
   - Recording Shortcut recorder
   - Mode picker (Hold to Talk / Toggle)
   - Description text

3. Test Hold-to-Talk mode:
   - Open any text field (Notes, TextEdit, browser)
   - Hold Option+Space (or configured shortcut)
   - Speak Vietnamese (e.g., "xin chao")
   - Release shortcut
   - Verify: Recording stops, text appears at cursor

4. Test Toggle mode:
   - Change mode to "Toggle" in Settings
   - Open text field
   - Press Option+Space to start
   - Speak
   - Press Option+Space to stop
   - Verify: Text appears at cursor

5. Test custom shortcut:
   - Click shortcut recorder
   - Press new key combo (e.g., Cmd+Shift+M)
   - Test recording with new shortcut

6. Test with different apps:
   - TextEdit (native)
   - Notes (native)
   - VSCode (Electron) - should work via clipboard paste
   - Browser text field
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. Build succeeds without errors
2. Option+Space triggers recording from any app
3. Text inserted at cursor after transcription
4. Settings shows hotkey recorder and mode picker
5. Both hold-to-talk and toggle modes work
6. Custom shortcut can be set and works
</verification>

<success_criteria>
- Global hotkey works from any app (not just when VoiceType is focused)
- Hold-to-talk: Hold to record, release to transcribe and insert
- Toggle: Press to start, press again to stop and insert
- Text appears at cursor in focused text field
- User can configure custom hotkey in Settings
- Clipboard fallback works in Electron apps
</success_criteria>

<output>
After completion, create `.planning/phases/03-system-integration/03-02-SUMMARY.md`
</output>
