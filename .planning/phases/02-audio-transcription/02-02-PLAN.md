---
phase: 02-audio-transcription
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - LocalTranscript/LocalTranscript/LocalTranscriptApp.swift
  - LocalTranscript/LocalTranscript/Views/MenuBarView.swift
  - LocalTranscript/LocalTranscript/Views/FloatingIndicator.swift
  - LocalTranscript/LocalTranscript/Views/FloatingIndicatorPanel.swift
  - LocalTranscript/LocalTranscript/Utilities/AudioFeedback.swift
autonomous: true

must_haves:
  truths:
    - "Menu bar icon changes when recording is active"
    - "Menu bar icon pulses/animates during recording"
    - "Floating indicator appears on screen during recording"
    - "Floating indicator visible in fullscreen apps"
    - "Audio beep plays when recording starts"
    - "Audio beep plays when recording stops"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Views/FloatingIndicator.swift"
      provides: "SwiftUI content for floating recording indicator"
      min_lines: 20
    - path: "LocalTranscript/LocalTranscript/Views/FloatingIndicatorPanel.swift"
      provides: "NSPanel subclass for always-on-top floating window"
      exports: ["FloatingIndicatorPanel"]
    - path: "LocalTranscript/LocalTranscript/Utilities/AudioFeedback.swift"
      provides: "System sound playback for recording start/stop"
      exports: ["AudioFeedback"]
  key_links:
    - from: "LocalTranscriptApp.swift"
      to: "appState.isRecording"
      via: "MenuBarExtra label Image"
      pattern: "isRecording.*waveform"
    - from: "FloatingIndicatorPanel"
      to: "collectionBehavior"
      via: "NSPanel level and collectionBehavior"
      pattern: "canJoinAllSpaces.*fullScreenAuxiliary"
---

<objective>
Implement visual and audio feedback for recording state: dynamic menu bar icon, floating indicator window, and start/stop beep sounds.

Purpose: Users need clear feedback that recording is active - especially important when working in fullscreen apps where the menu bar may be hidden.
Output: Animated menu bar icon, floating indicator NSPanel, audio feedback utility
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-audio-transcription/02-RESEARCH.md

# Existing code
@LocalTranscript/LocalTranscript/LocalTranscriptApp.swift
@LocalTranscript/LocalTranscript/Views/MenuBarView.swift
@LocalTranscript/LocalTranscript/Models/AppState.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MenuBarExtra label for dynamic recording icon</name>
  <files>LocalTranscript/LocalTranscript/LocalTranscriptApp.swift</files>
  <action>
Update the MenuBarExtra label to show different icons and animation based on recording state.

Change from:
```swift
} label: {
    Image(systemName: "waveform")
}
```

To (using appState.isRecording):
```swift
} label: {
    Image(systemName: appState.isRecording ? "waveform.circle.fill" : "waveform")
        .symbolEffect(.pulse, isActive: appState.isRecording)
}
```

This requires the MenuBarExtra to observe appState. The appState is already @State in the App struct, so the label should re-render when isRecording changes.

Notes:
- waveform.circle.fill is filled version (visually distinct when recording)
- .symbolEffect(.pulse) creates subtle animation when active
- SF Symbols support this natively on macOS 14+
  </action>
  <verify>
Build succeeds: `cd /Users/sipher/Downloads/local-transcript-master/LocalTranscript && xcodebuild -scheme LocalTranscript -configuration Debug build 2>&1 | tail -20`
LocalTranscriptApp.swift contains "waveform.circle.fill" and "symbolEffect"
  </verify>
  <done>
Menu bar icon changes from waveform to waveform.circle.fill and pulses when isRecording is true.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create floating indicator panel (NSPanel + SwiftUI)</name>
  <files>
LocalTranscript/LocalTranscript/Views/FloatingIndicatorPanel.swift
LocalTranscript/LocalTranscript/Views/FloatingIndicator.swift
  </files>
  <action>
Create two files for the floating recording indicator:

**FloatingIndicatorPanel.swift** - NSPanel subclass for always-on-top window:
```swift
import AppKit
import SwiftUI

class FloatingIndicatorPanel: NSPanel {
    init(content: some View) {
        super.init(
            contentRect: NSRect(x: 0, y: 0, width: 140, height: 44),
            styleMask: [.nonactivatingPanel, .fullSizeContentView, .borderless],
            backing: .buffered,
            defer: false
        )

        isFloatingPanel = true
        level = .floating
        collectionBehavior = [.canJoinAllSpaces, .fullScreenAuxiliary]
        hidesOnDeactivate = false  // Stay visible when app loses focus
        isMovableByWindowBackground = true
        titlebarAppearsTransparent = true
        titleVisibility = .hidden
        backgroundColor = .clear
        isOpaque = false
        hasShadow = true

        contentView = NSHostingView(rootView: content)

        // Position at top-center of main screen
        if let screen = NSScreen.main {
            let screenFrame = screen.visibleFrame
            let x = screenFrame.midX - frame.width / 2
            let y = screenFrame.maxY - frame.height - 20  // 20pt from top
            setFrameOrigin(NSPoint(x: x, y: y))
        }
    }
}
```

Key configuration (from research):
- `level = .floating` - stays above other windows
- `collectionBehavior = [.canJoinAllSpaces, .fullScreenAuxiliary]` - visible in fullscreen apps
- `hidesOnDeactivate = false` - stays visible when app not focused
- `isMovableByWindowBackground = true` - user can drag it

**FloatingIndicator.swift** - SwiftUI content:
```swift
import SwiftUI

struct FloatingIndicator: View {
    var body: some View {
        HStack(spacing: 8) {
            Circle()
                .fill(.red)
                .frame(width: 12, height: 12)

            Text("Recording")
                .font(.system(size: 13, weight: .medium))
                .foregroundStyle(.primary)
        }
        .padding(.horizontal, 16)
        .padding(.vertical, 10)
        .background {
            RoundedRectangle(cornerRadius: 22)
                .fill(.ultraThinMaterial)
        }
    }
}
```

Design:
- Pill-shaped with rounded corners
- Red dot + "Recording" text
- Uses .ultraThinMaterial for macOS vibrancy effect
- Compact size (doesn't obstruct user's work)
  </action>
  <verify>
Build succeeds with both new files.
FloatingIndicatorPanel has collectionBehavior with canJoinAllSpaces.
  </verify>
  <done>
FloatingIndicatorPanel (NSPanel) and FloatingIndicator (SwiftUI content) created. Panel configured for always-on-top, visible in fullscreen apps.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AudioFeedback utility for start/stop sounds</name>
  <files>LocalTranscript/LocalTranscript/Utilities/AudioFeedback.swift</files>
  <action>
Create Utilities folder and AudioFeedback.swift:

```swift
import AudioToolbox
import AppKit

struct AudioFeedback {
    /// Play sound when recording starts
    static func playStartSound() {
        // System sound 1113 = "begin_record" on macOS
        // Fallback to beep if system sound doesn't work
        AudioServicesPlaySystemSound(1113)
    }

    /// Play sound when recording stops
    static func playStopSound() {
        // System sound 1114 = "end_record" on macOS
        AudioServicesPlaySystemSound(1114)
    }

    /// Fallback beep (if system sounds don't work)
    static func playBeep() {
        NSSound.beep()
    }
}
```

System sound IDs from research:
- 1113 = begin_record (short ascending tone)
- 1114 = end_record (short descending tone)

Note: These system sounds respect user's volume settings and mute state.
If testing shows 1113/1114 don't work on macOS, can switch to NSSound.beep() or custom sound files.
  </action>
  <verify>
Build succeeds with AudioFeedback.swift.
File imports AudioToolbox.
  </verify>
  <done>
AudioFeedback utility created with playStartSound() and playStopSound() using system sounds.
  </done>
</task>

</tasks>

<verification>
Build the project and verify:
1. No compile errors
2. Menu bar label uses conditional icon
3. FloatingIndicatorPanel configured for fullscreen visibility
4. AudioFeedback struct exists with AudioToolbox import
</verification>

<success_criteria>
- MenuBarExtra label changes icon based on appState.isRecording
- Symbol pulse effect applied when recording
- FloatingIndicatorPanel created with correct NSPanel configuration
- FloatingIndicator SwiftUI view shows red dot and "Recording" text
- AudioFeedback utility created with system sound playback
- Project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-audio-transcription/02-02-SUMMARY.md`
</output>
