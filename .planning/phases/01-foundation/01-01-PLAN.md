---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - LocalTranscript/LocalTranscriptApp.swift
  - LocalTranscript/Views/MenuBarView.swift
  - LocalTranscript/Views/SettingsView.swift
  - LocalTranscript/Views/HiddenWindowView.swift
  - LocalTranscript/Services/PermissionManager.swift
  - LocalTranscript/Models/AppState.swift
  - LocalTranscript/Info.plist
  - LocalTranscript/LocalTranscript.entitlements
autonomous: true

must_haves:
  truths:
    - "App appears in menu bar with waveform icon"
    - "App does NOT appear in Dock"
    - "User can click menu bar icon to see menu"
    - "User can open Settings from menu"
    - "Settings window appears and receives focus"
    - "User can quit app from menu"
    - "Permission status is displayed in Settings"
  artifacts:
    - path: "LocalTranscript/LocalTranscriptApp.swift"
      provides: "@main app entry with MenuBarExtra and Settings scenes"
      contains: "MenuBarExtra"
    - path: "LocalTranscript/Views/MenuBarView.swift"
      provides: "Menu bar dropdown content"
      exports: ["MenuBarView"]
    - path: "LocalTranscript/Views/SettingsView.swift"
      provides: "Settings window content with permissions"
      exports: ["SettingsView"]
    - path: "LocalTranscript/Views/HiddenWindowView.swift"
      provides: "Hidden window for Settings activation workaround"
      exports: ["HiddenWindowView"]
    - path: "LocalTranscript/Services/PermissionManager.swift"
      provides: "Microphone and Accessibility permission checking"
      exports: ["PermissionManager"]
    - path: "LocalTranscript/Info.plist"
      provides: "LSUIElement=true, NSMicrophoneUsageDescription"
      contains: "LSUIElement"
    - path: "LocalTranscript/LocalTranscript.entitlements"
      provides: "Non-sandboxed entitlements with audio-input"
      contains: "com.apple.security.device.audio-input"
  key_links:
    - from: "LocalTranscriptApp.swift"
      to: "MenuBarView.swift"
      via: "MenuBarExtra content"
      pattern: "MenuBarView"
    - from: "LocalTranscriptApp.swift"
      to: "HiddenWindowView.swift"
      via: "Window scene for Settings workaround"
      pattern: "HiddenWindowView"
    - from: "MenuBarView.swift"
      to: "NotificationCenter"
      via: "Settings open request"
      pattern: "openSettingsRequest"
    - from: "SettingsView.swift"
      to: "PermissionManager.swift"
      via: "Permission status checks"
      pattern: "permissionManager"
---

<objective>
Create the menu bar app shell with SwiftUI MenuBarExtra, proper non-sandboxed architecture, and permission handling infrastructure.

Purpose: Establishes the foundational architecture that all subsequent phases build upon. Getting this right (non-sandboxed, Settings workaround, permission flow) prevents costly rework later.

Output: Working menu bar app with Settings window, permission status display, and proper macOS integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Xcode project with non-sandboxed SwiftUI menu bar architecture</name>
  <files>
    - LocalTranscript/LocalTranscriptApp.swift
    - LocalTranscript/Info.plist
    - LocalTranscript/LocalTranscript.entitlements
  </files>
  <action>
Create new Xcode project "LocalTranscript" as macOS App with SwiftUI lifecycle.

**Project configuration:**
1. Target: macOS 14.0+ (for openSettings environment)
2. Language: Swift
3. Interface: SwiftUI
4. Bundle ID: com.voicetype.localtranscript (or user's preference)

**Info.plist - CRITICAL settings:**
```xml
<key>LSUIElement</key>
<true/>

<key>NSMicrophoneUsageDescription</key>
<string>LocalTranscript needs microphone access for speech-to-text transcription.</string>

<key>NSAppleEventsUsageDescription</key>
<string>LocalTranscript needs accessibility access to insert transcribed text into other applications.</string>
```

**Entitlements - NON-SANDBOXED:**
```xml
<key>com.apple.security.device.audio-input</key>
<true/>
<!-- NO App Sandbox entitlement - intentionally non-sandboxed -->
<!-- NO com.apple.security.accessibility - controlled via System Settings -->
```

**LocalTranscriptApp.swift skeleton:**
```swift
import SwiftUI

@main
struct LocalTranscriptApp: App {
    @State private var appState = AppState()

    var body: some Scene {
        // Hidden window MUST come first (Settings workaround)
        Window("Hidden", id: "HiddenWindow") {
            HiddenWindowView()
                .environment(appState)
        }
        .windowResizability(.contentSize)
        .defaultSize(width: 1, height: 1)

        MenuBarExtra {
            MenuBarView()
                .environment(appState)
        } label: {
            Image(systemName: "waveform")
        }
        .menuBarExtraStyle(.menu)

        Settings {
            SettingsView()
                .environment(appState)
                .onDisappear {
                    NotificationCenter.default.post(name: .settingsWindowClosed, object: nil)
                }
        }
    }
}
```

**CRITICAL:** Do NOT add App Sandbox entitlement. This app must be non-sandboxed for Accessibility API access in Phase 3.
  </action>
  <verify>
    - Run `xcodebuild -list` in project directory to verify project structure
    - Verify Info.plist contains LSUIElement=true
    - Verify entitlements file does NOT contain com.apple.security.app-sandbox
    - Build succeeds: `xcodebuild -scheme LocalTranscript -configuration Debug build`
  </verify>
  <done>
    - Xcode project exists with macOS 14+ target
    - Info.plist has LSUIElement=true and NSMicrophoneUsageDescription
    - Entitlements has audio-input but NO sandbox
    - Project builds successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement MenuBarExtra with hidden window Settings workaround</name>
  <files>
    - LocalTranscript/LocalTranscriptApp.swift
    - LocalTranscript/Views/MenuBarView.swift
    - LocalTranscript/Views/HiddenWindowView.swift
    - LocalTranscript/Views/SettingsView.swift
    - LocalTranscript/Models/AppState.swift
  </files>
  <action>
**AppState.swift** - Observable app state:
```swift
import SwiftUI

@Observable
class AppState {
    var isRecording = false
    var permissionManager = PermissionManager()
}
```

**MenuBarView.swift** - Menu bar dropdown:
```swift
import SwiftUI

struct MenuBarView: View {
    @Environment(AppState.self) var appState

    var body: some View {
        Group {
            Text("Status: Ready")
                .foregroundStyle(.secondary)

            Divider()

            Button("Settings...") {
                NotificationCenter.default.post(name: .openSettingsRequest, object: nil)
            }
            .keyboardShortcut(",", modifiers: .command)

            Divider()

            Button("Quit LocalTranscript") {
                NSApplication.shared.terminate(nil)
            }
            .keyboardShortcut("q", modifiers: .command)
        }
    }
}
```

**HiddenWindowView.swift** - Settings activation workaround (CRITICAL pattern from research):
```swift
import SwiftUI

struct HiddenWindowView: View {
    @Environment(\.openSettings) private var openSettings

    var body: some View {
        Color.clear
            .frame(width: 1, height: 1)
            .onReceive(NotificationCenter.default.publisher(for: .openSettingsRequest)) { _ in
                Task { @MainActor in
                    // Temporarily show dock icon so Settings can receive focus
                    NSApp.setActivationPolicy(.regular)
                    try? await Task.sleep(for: .milliseconds(100))

                    NSApp.activate(ignoringOtherApps: true)
                    openSettings()

                    try? await Task.sleep(for: .milliseconds(200))
                    if let window = NSApp.windows.first(where: {
                        $0.identifier?.rawValue == "com.apple.SwiftUI.Settings" ||
                        $0.title.localizedCaseInsensitiveContains("settings")
                    }) {
                        window.makeKeyAndOrderFront(nil)
                        window.orderFrontRegardless()
                    }
                }
            }
            .onReceive(NotificationCenter.default.publisher(for: .settingsWindowClosed)) { _ in
                // Hide dock icon again
                NSApp.setActivationPolicy(.accessory)
            }
    }
}

extension Notification.Name {
    static let openSettingsRequest = Notification.Name("openSettingsRequest")
    static let settingsWindowClosed = Notification.Name("settingsWindowClosed")
}
```

**SettingsView.swift** - Basic shell (permissions added in Task 3):
```swift
import SwiftUI

struct SettingsView: View {
    @Environment(AppState.self) var appState

    var body: some View {
        Form {
            Section("General") {
                Text("Settings will appear here")
                    .foregroundStyle(.secondary)
            }
        }
        .formStyle(.grouped)
        .frame(width: 400, height: 300)
    }
}
```

**CRITICAL ordering in LocalTranscriptApp.swift:** Hidden window scene MUST be declared before Settings scene. This is required for the workaround to work.
  </action>
  <verify>
    - Build and run app
    - Verify app appears in menu bar with waveform icon
    - Verify app does NOT appear in Dock
    - Click menu bar icon - menu appears with Settings and Quit
    - Click Settings - Settings window opens AND receives focus
    - Close Settings - app returns to menu-bar-only mode (no Dock icon)
    - Click Quit - app terminates
  </verify>
  <done>
    - Menu bar icon shows waveform
    - No Dock icon visible
    - Menu opens on click with Settings and Quit options
    - Settings window opens and receives keyboard focus
    - Settings closes properly, Dock icon disappears
    - Quit terminates the app
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement PermissionManager and permission status UI</name>
  <files>
    - LocalTranscript/Services/PermissionManager.swift
    - LocalTranscript/Views/SettingsView.swift
  </files>
  <action>
**PermissionManager.swift** - Handle microphone and accessibility permissions:
```swift
import AVFoundation
import ApplicationServices

@Observable
class PermissionManager {
    enum MicrophoneStatus {
        case authorized
        case denied
        case notDetermined
    }

    func checkMicrophonePermission() -> MicrophoneStatus {
        switch AVCaptureDevice.authorizationStatus(for: .audio) {
        case .authorized: return .authorized
        case .denied, .restricted: return .denied
        case .notDetermined: return .notDetermined
        @unknown default: return .notDetermined
        }
    }

    func requestMicrophonePermission() async -> Bool {
        await AVCaptureDevice.requestAccess(for: .audio)
    }

    func checkAccessibilityPermission() -> Bool {
        AXIsProcessTrusted()
    }

    func requestAccessibilityPermission() {
        let options: NSDictionary = [
            kAXTrustedCheckOptionPrompt.takeUnretainedValue() as String: true
        ]
        AXIsProcessTrustedWithOptions(options)
    }

    func openAccessibilitySettings() {
        if let url = URL(string: "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility") {
            NSWorkspace.shared.open(url)
        }
    }

    func openMicrophoneSettings() {
        if let url = URL(string: "x-apple.systempreferences:com.apple.preference.security?Privacy_Microphone") {
            NSWorkspace.shared.open(url)
        }
    }
}
```

**Update SettingsView.swift** with permission status rows:
```swift
import SwiftUI

struct SettingsView: View {
    @Environment(AppState.self) var appState
    @State private var micStatus: PermissionManager.MicrophoneStatus = .notDetermined
    @State private var accessibilityGranted = false

    var body: some View {
        Form {
            Section("Permissions") {
                PermissionRow(
                    title: "Microphone",
                    description: "Required for voice recording",
                    isGranted: micStatus == .authorized,
                    action: {
                        if micStatus == .notDetermined {
                            Task {
                                _ = await appState.permissionManager.requestMicrophonePermission()
                                refreshPermissions()
                            }
                        } else {
                            appState.permissionManager.openMicrophoneSettings()
                        }
                    }
                )

                PermissionRow(
                    title: "Accessibility",
                    description: "Required for text insertion (Phase 3)",
                    isGranted: accessibilityGranted,
                    action: {
                        if !accessibilityGranted {
                            appState.permissionManager.requestAccessibilityPermission()
                        } else {
                            appState.permissionManager.openAccessibilitySettings()
                        }
                    }
                )
            }
        }
        .formStyle(.grouped)
        .frame(width: 450, height: 300)
        .onAppear {
            refreshPermissions()
        }
    }

    private func refreshPermissions() {
        micStatus = appState.permissionManager.checkMicrophonePermission()
        accessibilityGranted = appState.permissionManager.checkAccessibilityPermission()
    }
}

struct PermissionRow: View {
    let title: String
    let description: String
    let isGranted: Bool
    let action: () -> Void

    var body: some View {
        HStack {
            VStack(alignment: .leading, spacing: 2) {
                Text(title)
                Text(description)
                    .font(.caption)
                    .foregroundStyle(.secondary)
            }

            Spacer()

            if isGranted {
                Image(systemName: "checkmark.circle.fill")
                    .foregroundStyle(.green)
            } else {
                Button("Grant") {
                    action()
                }
                .buttonStyle(.borderedProminent)
                .controlSize(.small)
            }
        }
        .padding(.vertical, 4)
    }
}
```

**Note:** Accessibility permission can only be granted manually by user in System Settings. The "Grant" button will either show the prompt (first time) or open System Settings (subsequent times).
  </action>
  <verify>
    - Build and run app
    - Open Settings from menu bar
    - Verify Permissions section shows Microphone and Accessibility rows
    - Click Grant on Microphone - system permission dialog appears (or settings opens if already decided)
    - Verify status updates after granting/denying
    - Click Grant on Accessibility - System Settings opens to correct page
    - After granting Accessibility in System Settings, reopen Settings - shows checkmark
  </verify>
  <done>
    - PermissionManager can check microphone and accessibility status
    - PermissionManager can request microphone permission
    - PermissionManager can open System Settings for both permissions
    - Settings UI shows permission status with green checkmarks when granted
    - Grant buttons trigger appropriate permission flows
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Menu bar presence:**
   - App icon (waveform) visible in menu bar
   - NO Dock icon visible
   - Menu opens on click

2. **Settings window:**
   - Opens from menu bar > Settings
   - Window appears in foreground and receives focus
   - Closes properly (Dock icon disappears)

3. **Permission handling:**
   - Microphone permission request triggers system dialog
   - Accessibility permission opens System Settings
   - Status accurately reflects granted/denied state

4. **Architecture verification:**
   - `grep -r "app-sandbox" LocalTranscript/*.entitlements` returns nothing (non-sandboxed)
   - `grep "LSUIElement" LocalTranscript/Info.plist` shows true
   - `grep "NSMicrophoneUsageDescription" LocalTranscript/Info.plist` shows usage string
</verification>

<success_criteria>
- [ ] App appears in menu bar with waveform icon, NOT in Dock
- [ ] Settings window opens from menu and receives keyboard focus
- [ ] Microphone permission can be requested and status displayed
- [ ] Accessibility permission status displayed, opens System Settings for granting
- [ ] App is non-sandboxed (no app-sandbox entitlement)
- [ ] Project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
