---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - LocalTranscript/Services/ModelManager.swift
  - LocalTranscript/Services/LaunchManager.swift
  - LocalTranscript/Models/AppState.swift
  - LocalTranscript/Views/MenuBarView.swift
  - LocalTranscript/Views/SettingsView.swift
  - Package.swift (or Xcode SPM)
autonomous: true

must_haves:
  truths:
    - "SwiftWhisper package is added as dependency"
    - "App can load PhoWhisper GGML model asynchronously"
    - "Model loading shows progress indicator in menu bar"
    - "Model persists across app launches (stored in Application Support)"
    - "User can toggle Start at Login in Settings"
    - "Login item state persists and works correctly"
    - "User preferences persist via UserDefaults"
  artifacts:
    - path: "LocalTranscript/Services/ModelManager.swift"
      provides: "Async model loading with SwiftWhisper"
      exports: ["ModelManager"]
      contains: "SwiftWhisper"
    - path: "LocalTranscript/Services/LaunchManager.swift"
      provides: "SMAppService login item management"
      exports: ["LaunchManager"]
      contains: "SMAppService"
    - path: "LocalTranscript/Models/AppState.swift"
      provides: "Updated state with ModelManager and LaunchManager"
      contains: "modelManager"
  key_links:
    - from: "ModelManager.swift"
      to: "SwiftWhisper"
      via: "import and Whisper initialization"
      pattern: "import SwiftWhisper"
    - from: "LaunchManager.swift"
      to: "SMAppService"
      via: "register/unregister calls"
      pattern: "SMAppService.mainApp"
    - from: "MenuBarView.swift"
      to: "ModelManager.swift"
      via: "model status display"
      pattern: "modelManager.isLoading"
    - from: "SettingsView.swift"
      to: "LaunchManager.swift"
      via: "login toggle binding"
      pattern: "launchManager.launchAtLogin"
---

<objective>
Integrate SwiftWhisper for PhoWhisper model loading and implement login item management with SMAppService.

Purpose: Enables Vietnamese speech recognition with PhoWhisper (4.97% WER) and completes the "app persistence" requirements (login item, user preferences).

Output: App that can load PhoWhisper model asynchronously and persist across system restarts via login item.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/research/STACK.md

# Prior plan context
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SwiftWhisper dependency and implement ModelManager</name>
  <files>
    - Package.swift (or Xcode SPM configuration)
    - LocalTranscript/Services/ModelManager.swift
  </files>
  <action>
**Add SwiftWhisper via Xcode SPM:**

In Xcode:
1. File > Add Package Dependencies
2. URL: `https://github.com/exPHAT/SwiftWhisper.git`
3. Version: from 1.2.0

Or if using Package.swift:
```swift
dependencies: [
    .package(url: "https://github.com/exPHAT/SwiftWhisper.git", from: "1.2.0"),
]
```

**ModelManager.swift** - Async model loading:
```swift
import Foundation
import SwiftWhisper

@Observable
class ModelManager {
    private(set) var whisper: Whisper?
    private(set) var isLoading = false
    private(set) var loadError: Error?
    private(set) var loadProgress: String = ""

    enum ModelError: LocalizedError {
        case modelNotFound
        case loadFailed(Error)

        var errorDescription: String? {
            switch self {
            case .modelNotFound:
                return "PhoWhisper model file not found. Please download the model."
            case .loadFailed(let error):
                return "Failed to load model: \(error.localizedDescription)"
            }
        }
    }

    var isModelLoaded: Bool {
        whisper != nil
    }

    var modelStoragePath: URL {
        let appSupport = FileManager.default.urls(for: .applicationSupportDirectory, in: .userDomainMask)[0]
        let appFolder = appSupport.appendingPathComponent("LocalTranscript", isDirectory: true)

        // Create directory if needed
        try? FileManager.default.createDirectory(at: appFolder, withIntermediateDirectories: true)

        return appFolder
    }

    var modelFilePath: URL {
        modelStoragePath.appendingPathComponent("ggml-phowhisper-medium.bin")
    }

    var isModelFilePresent: Bool {
        FileManager.default.fileExists(atPath: modelFilePath.path)
    }

    /// Load model asynchronously. Call this on first recording trigger, not app launch.
    func loadModel() async throws {
        guard whisper == nil, !isLoading else { return }

        isLoading = true
        loadError = nil
        loadProgress = "Loading model..."

        defer {
            isLoading = false
            loadProgress = ""
        }

        // Check for model in Application Support first
        var modelURL = modelFilePath
        if !FileManager.default.fileExists(atPath: modelURL.path) {
            // Fallback to bundled model (if included in app bundle)
            if let bundledURL = Bundle.main.url(forResource: "ggml-phowhisper-medium", withExtension: "bin") {
                modelURL = bundledURL
            } else {
                throw ModelError.modelNotFound
            }
        }

        loadProgress = "Initializing PhoWhisper..."

        do {
            // SwiftWhisper loads synchronously but we're in async context
            // This prevents UI blocking
            whisper = try await Task.detached(priority: .userInitiated) {
                Whisper(fromFileURL: modelURL)
            }.value

            if whisper == nil {
                throw ModelError.modelNotFound
            }
        } catch {
            loadError = error
            throw ModelError.loadFailed(error)
        }
    }

    /// Unload model to free memory (call after period of inactivity)
    func unloadModel() {
        whisper = nil
    }
}
```

**Note on model file:**
- For MVP, the model file needs to be manually placed in `~/Library/Application Support/LocalTranscript/ggml-phowhisper-medium.bin`
- Download from: https://huggingface.co/dongxiat/ggml-PhoWhisper-medium
- Future enhancement: Add model download UI in Phase 4

**IMPORTANT:** Do NOT load model at app launch. Load lazily on first recording trigger (Phase 2). This prevents 3-5 second startup freeze.
  </action>
  <verify>
    - Build project with SwiftWhisper dependency: `xcodebuild -scheme LocalTranscript build`
    - Verify SwiftWhisper is linked: check build log for SwiftWhisper
    - Verify ModelManager compiles without errors
    - Manually test: Place model file in Application Support, call loadModel(), verify whisper != nil
  </verify>
  <done>
    - SwiftWhisper package added as dependency
    - ModelManager can locate model in Application Support
    - ModelManager can load model asynchronously
    - Model loading state (isLoading, loadError, loadProgress) is observable
    - Model can be unloaded to free memory
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement LaunchManager with SMAppService and user preferences</name>
  <files>
    - LocalTranscript/Services/LaunchManager.swift
    - LocalTranscript/Models/AppState.swift
    - LocalTranscript/Views/SettingsView.swift
  </files>
  <action>
**LaunchManager.swift** - Login item management:
```swift
import Foundation
import ServiceManagement

@Observable
class LaunchManager {
    var launchAtLogin: Bool = false {
        didSet {
            guard oldValue != launchAtLogin else { return }
            updateLoginItem()
        }
    }

    init() {
        syncFromSystem()
    }

    /// Sync state from system (user may have changed in System Settings)
    func syncFromSystem() {
        launchAtLogin = SMAppService.mainApp.status == .enabled
    }

    private func updateLoginItem() {
        do {
            if launchAtLogin {
                try SMAppService.mainApp.register()
            } else {
                try SMAppService.mainApp.unregister()
            }
        } catch {
            // Revert on failure
            print("Failed to update login item: \(error)")
            launchAtLogin = SMAppService.mainApp.status == .enabled
        }
    }
}
```

**Update AppState.swift** to include managers:
```swift
import SwiftUI

@Observable
class AppState {
    var isRecording = false

    let permissionManager = PermissionManager()
    let modelManager = ModelManager()
    let launchManager = LaunchManager()
}
```

**Update SettingsView.swift** - Add General section with login toggle:
```swift
import SwiftUI

struct SettingsView: View {
    @Environment(AppState.self) var appState
    @State private var micStatus: PermissionManager.MicrophoneStatus = .notDetermined
    @State private var accessibilityGranted = false

    var body: some View {
        Form {
            Section("General") {
                @Bindable var launchManager = appState.launchManager
                Toggle("Start at Login", isOn: $launchManager.launchAtLogin)
                    .onAppear {
                        appState.launchManager.syncFromSystem()
                    }
            }

            Section("Model") {
                HStack {
                    Text("PhoWhisper Medium")
                    Spacer()
                    if appState.modelManager.isModelLoaded {
                        Image(systemName: "checkmark.circle.fill")
                            .foregroundStyle(.green)
                        Text("Loaded")
                            .foregroundStyle(.secondary)
                    } else if appState.modelManager.isLoading {
                        ProgressView()
                            .controlSize(.small)
                        Text("Loading...")
                            .foregroundStyle(.secondary)
                    } else if appState.modelManager.isModelFilePresent {
                        Text("Ready to load")
                            .foregroundStyle(.secondary)
                    } else {
                        Image(systemName: "exclamationmark.triangle.fill")
                            .foregroundStyle(.orange)
                        Text("Model not found")
                            .foregroundStyle(.secondary)
                    }
                }

                if !appState.modelManager.isModelFilePresent {
                    Text("Download model from HuggingFace and place in:\n\(appState.modelManager.modelStoragePath.path)")
                        .font(.caption)
                        .foregroundStyle(.secondary)

                    Button("Open Model Folder") {
                        NSWorkspace.shared.open(appState.modelManager.modelStoragePath)
                    }
                }

                if let error = appState.modelManager.loadError {
                    Text(error.localizedDescription)
                        .font(.caption)
                        .foregroundStyle(.red)
                }
            }

            Section("Permissions") {
                PermissionRow(
                    title: "Microphone",
                    description: "Required for voice recording",
                    isGranted: micStatus == .authorized,
                    action: {
                        if micStatus == .notDetermined {
                            Task {
                                _ = await appState.permissionManager.requestMicrophonePermission()
                                refreshPermissions()
                            }
                        } else {
                            appState.permissionManager.openMicrophoneSettings()
                        }
                    }
                )

                PermissionRow(
                    title: "Accessibility",
                    description: "Required for text insertion (Phase 3)",
                    isGranted: accessibilityGranted,
                    action: {
                        if !accessibilityGranted {
                            appState.permissionManager.requestAccessibilityPermission()
                        } else {
                            appState.permissionManager.openAccessibilitySettings()
                        }
                    }
                )
            }
        }
        .formStyle(.grouped)
        .frame(width: 450, height: 400)
        .onAppear {
            refreshPermissions()
        }
    }

    private func refreshPermissions() {
        micStatus = appState.permissionManager.checkMicrophonePermission()
        accessibilityGranted = appState.permissionManager.checkAccessibilityPermission()
    }
}
```

**User preferences via @AppStorage** (already works with UserDefaults, no additional code needed for SET-02):
- @AppStorage values automatically persist
- Can add more preferences as needed in future phases
  </action>
  <verify>
    - Build and run app
    - Open Settings, verify General section has "Start at Login" toggle
    - Toggle ON - verify appears in System Settings > General > Login Items
    - Toggle OFF - verify removed from Login Items
    - Quit and relaunch - verify toggle state persists correctly
    - Verify Model section shows model status
  </verify>
  <done>
    - LaunchManager uses SMAppService for login item
    - Toggle state syncs with system
    - Settings shows Start at Login toggle in General section
    - Model section shows status (loaded/loading/not found)
    - Model folder can be opened from Settings
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate model status into MenuBarView and test model loading</name>
  <files>
    - LocalTranscript/Views/MenuBarView.swift
  </files>
  <action>
**Update MenuBarView.swift** to show model status:
```swift
import SwiftUI

struct MenuBarView: View {
    @Environment(AppState.self) var appState

    var body: some View {
        Group {
            // Model status
            if appState.modelManager.isLoading {
                HStack {
                    ProgressView()
                        .controlSize(.small)
                    Text(appState.modelManager.loadProgress.isEmpty ? "Loading model..." : appState.modelManager.loadProgress)
                }
            } else if appState.modelManager.isModelLoaded {
                Label("Ready", systemImage: "checkmark.circle")
                    .foregroundStyle(.green)
            } else if appState.modelManager.isModelFilePresent {
                Label("Model ready to load", systemImage: "circle")
                    .foregroundStyle(.secondary)
            } else {
                Label("Model not found", systemImage: "exclamationmark.triangle")
                    .foregroundStyle(.orange)
            }

            Divider()

            // Load model button (for testing - will be automatic in Phase 2)
            if !appState.modelManager.isModelLoaded && appState.modelManager.isModelFilePresent && !appState.modelManager.isLoading {
                Button("Load Model") {
                    Task {
                        try? await appState.modelManager.loadModel()
                    }
                }
            }

            if appState.modelManager.isModelLoaded {
                Button("Unload Model") {
                    appState.modelManager.unloadModel()
                }
            }

            Divider()

            Button("Settings...") {
                NotificationCenter.default.post(name: .openSettingsRequest, object: nil)
            }
            .keyboardShortcut(",", modifiers: .command)

            Divider()

            Button("Quit LocalTranscript") {
                NSApplication.shared.terminate(nil)
            }
            .keyboardShortcut("q", modifiers: .command)
        }
    }
}
```

**Testing model loading:**
1. Download ggml-phowhisper-medium.bin from https://huggingface.co/dongxiat/ggml-PhoWhisper-medium/tree/main
2. Place in ~/Library/Application Support/LocalTranscript/
3. Run app, click "Load Model" in menu
4. Verify model loads (status changes to "Ready")
5. Verify model persists (stays loaded until "Unload Model" clicked)
6. Quit and relaunch - model should NOT auto-load (lazy loading for Phase 2)

**Note:** In Phase 2, model loading will be triggered automatically on first recording. The manual buttons are for testing in Phase 1.
  </action>
  <verify>
    - Build and run app
    - Without model file: Menu shows "Model not found", Settings shows path and Open Folder button
    - With model file: Menu shows "Model ready to load" and "Load Model" button
    - Click Load Model: Shows loading indicator, then "Ready" on success
    - Click Unload Model: Returns to "Model ready to load" state
    - Verify no UI freeze during model loading (async works)
  </verify>
  <done>
    - MenuBarView shows current model status
    - Loading indicator appears during model load
    - Manual Load/Unload buttons work for testing
    - Model loads asynchronously without freezing UI
    - Error states display helpful messages
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **SwiftWhisper integration:**
   - Build log shows SwiftWhisper compiled
   - `import SwiftWhisper` works in ModelManager

2. **Model loading:**
   - Model file detected in Application Support
   - Model loads asynchronously (no UI freeze)
   - Loading progress shown in menu and Settings
   - Model can be unloaded to free memory

3. **Login item:**
   - Toggle in Settings works
   - State appears in System Settings > Login Items
   - Toggle OFF removes from Login Items
   - State persists across app launches

4. **End-to-end test:**
   ```bash
   # Verify login item registration
   # Toggle ON in app, then check:
   sfltool dumpbtm | grep -i localtranscript
   ```
</verification>

<success_criteria>
- [ ] SwiftWhisper package is a project dependency
- [ ] ModelManager can load PhoWhisper GGML model asynchronously
- [ ] Model loading shows progress indicator (no UI freeze)
- [ ] Model status displayed in menu bar and Settings
- [ ] Start at Login toggle works via SMAppService
- [ ] Login item state persists correctly
- [ ] Model storage path is ~/Library/Application Support/LocalTranscript/
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
