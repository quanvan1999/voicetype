---
phase: 06-auto-segment
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  - LocalTranscript/LocalTranscript/Services/HotkeyService.swift
  - LocalTranscript/LocalTranscript/Views/SettingsView.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Extended silence does not produce hallucinated text"
    - "Auto-segment settings only visible when Toggle Mode is enabled"
    - "No Manual option shown in auto-segment picker (redundant in toggle mode)"
    - "Switching from Toggle to Hold-to-Talk stops any active recording"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Services/TranscriptionService.swift"
      provides: "RMS energy check + WhisperKit noSpeechProb filtering"
      contains: "rms > rmsThreshold"
    - path: "LocalTranscript/LocalTranscript/Services/HotkeyService.swift"
      provides: "Stop active recording on mode switch"
      contains: "if isRecording"
    - path: "LocalTranscript/LocalTranscript/Views/SettingsView.swift"
      provides: "Conditional auto-segment UI"
      contains: "if appState.hotkeyService.mode == .toggle"
  key_links:
    - from: "HotkeyService.mode.didSet"
      to: "onStop?()"
      via: "stop active recording before rebind"
      pattern: "isRecording.*onStop"
    - from: "TranscriptionService.handleSegment"
      to: "reject silent audio"
      via: "RMS energy threshold"
      pattern: "rms.*rmsThreshold"
---

<objective>
Fix 4 UAT issues from Phase 06 testing: Whisper hallucination on silence (Test 7), auto-segment UI visibility (Test 8), manual mode redundancy (Test 9), and mode switch recording stop (Test 10).

Purpose: Close remaining gaps to complete Phase 06 UAT validation
Output: All 4 UAT issues resolved, ready for retest
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-auto-segment/06-UAT.md
@.planning/phases/06-auto-segment/06-04-SUMMARY.md
@.claude/cache/agents/debug-agent/latest-output.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Whisper Hallucination on Silence</name>
  <files>LocalTranscript/LocalTranscript/Services/TranscriptionService.swift</files>
  <action>
Add two-layer protection against Whisper hallucination on silent audio:

1. **Pre-transcription RMS energy check** in `handleSegment()` (around line 282):
   - Calculate RMS energy: `let rms = sqrt(samples.map { $0 * $0 }.reduce(0, +) / Float(samples.count))`
   - Add threshold constant: `private let rmsThreshold: Float = 0.01`
   - Guard check: `guard rms > rmsThreshold else { logger.info("Segment rejected: RMS \(rms) below threshold"); return }`
   - Place after the existing `guard !samples.isEmpty else { return }` check

2. **Post-transcription WhisperKit metrics filter** in `transcribe()` (around line 450):
   - After getting results, filter segments using WhisperKit's TranscriptionSegment metrics
   - Access segments via `results.flatMap { $0.segments }`
   - Filter logic:
     - Reject if `segment.noSpeechProb > 0.7` (high probability of no speech)
     - Reject if `segment.avgLogprob < -1.5` (very low confidence)
     - Reject if `segment.compressionRatio > 2.4` (indicates repetitive hallucination)
   - Log rejections for debugging: `logger.info("Segment rejected: noSpeechProb \(segment.noSpeechProb)")`
   - Build text from remaining valid segments only

Note: WhisperKit TranscriptionResult has `.segments: [TranscriptionSegment]` where each segment has `noSpeechProb`, `avgLogprob`, and `compressionRatio` properties.
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -5`
  </verify>
  <done>Silent audio segments are rejected before transcription OR filtered post-transcription, no hallucinated text output</done>
</task>

<task type="auto">
  <name>Task 2: Fix Auto-Segment UI and Mode Switch</name>
  <files>LocalTranscript/LocalTranscript/Views/SettingsView.swift, LocalTranscript/LocalTranscript/Services/HotkeyService.swift</files>
  <action>
Three UI/behavior fixes:

**Fix 1: Auto-Segment section only visible in Toggle Mode** (SettingsView.swift)
- Wrap the entire `Section("Auto-Segment")` block (lines 60-87) with:
  ```swift
  if appState.hotkeyService.mode == .toggle {
      Section("Auto-Segment") {
          // existing content
      }
  }
  ```

**Fix 2: Remove redundant Manual mode picker** (SettingsView.swift)
- In Toggle Mode, the Auto-Segment section should only show a toggle switch, not a picker
- Replace the Picker (lines 61-66) with a simple Toggle:
  ```swift
  Toggle("Enable Auto-Segment", isOn: Binding(
      get: { segmentMode == SegmentMode.auto.rawValue },
      set: { segmentMode = $0 ? SegmentMode.auto.rawValue : SegmentMode.manual.rawValue }
  ))
  ```
- The silence threshold slider should only show when auto-segment is enabled (keep existing conditional on line 68)

**Fix 3: Stop active recording on mode switch** (HotkeyService.swift)
- In the `mode` property's `didSet` (lines 18-23), add logic to stop active recording before rebinding:
  ```swift
  var mode: RecordingMode = .holdToTalk {
      didSet {
          // Stop active recording before switching modes
          if isRecording {
              isRecording = false
              Task { await onStop?() }
          }
          UserDefaults.standard.set(mode.rawValue, forKey: "recordingMode")
          rebindHandlers()
      }
  }
  ```
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -5`
  </verify>
  <done>
- Auto-segment section hidden when Hold-to-Talk mode selected
- Toggle switch replaces picker in auto-segment section
- Switching modes stops any active recording immediately
  </done>
</task>

</tasks>

<verification>
1. Build verification:
   ```bash
   xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build
   ```

2. Code verification:
   - TranscriptionService.swift contains `rms > rmsThreshold` check
   - TranscriptionService.swift contains `noSpeechProb` filtering
   - SettingsView.swift has `if appState.hotkeyService.mode == .toggle` around Auto-Segment section
   - HotkeyService.swift mode didSet contains `if isRecording { isRecording = false`
</verification>

<success_criteria>
- Build succeeds without errors
- All 4 UAT issues have code fixes in place:
  - Test 7: Whisper hallucination prevented by RMS + noSpeechProb checks
  - Test 8: Auto-segment UI only shows in Toggle Mode
  - Test 9: Toggle switch instead of picker (no Manual option)
  - Test 10: Mode switch stops active recording
</success_criteria>

<output>
After completion, create `.planning/phases/06-auto-segment/06-05-SUMMARY.md`
</output>
