---
phase: 06-auto-segment
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - LocalTranscript/LocalTranscript/Models/SegmentMode.swift
  - LocalTranscript/LocalTranscript/Services/AudioRecorder.swift
  - LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  - LocalTranscript/LocalTranscript/Models/AppState.swift
autonomous: true

must_haves:
  truths:
    - "AudioRecorder feeds samples to VAD while continuing to buffer"
    - "Silence detection triggers segment extraction without stopping recording"
    - "TranscriptionService queues segments and continues accepting new ones"
    - "User can toggle auto-segment mode (manual vs auto)"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Models/SegmentMode.swift"
      provides: "Manual vs Auto segment mode enum"
      exports: ["SegmentMode"]
      min_lines: 10
    - path: "LocalTranscript/LocalTranscript/Services/AudioRecorder.swift"
      provides: "VAD integration with silence callback"
      contains: "VADService|onSilenceDetected"
      min_lines: 100
    - path: "LocalTranscript/LocalTranscript/Services/TranscriptionService.swift"
      provides: "Continuous mode with queue management"
      contains: "TranscriptionQueue|startContinuousRecording"
      min_lines: 250
  key_links:
    - from: "AudioRecorder.processBuffer"
      to: "VADService.processChunk"
      via: "chunk 512 samples and feed to VAD"
      pattern: "vadService.*processChunk|chunked.*512"
    - from: "AudioRecorder silence callback"
      to: "TranscriptionService segment handler"
      via: "onSilenceDetected closure"
      pattern: "onSilenceDetected"
    - from: "TranscriptionService"
      to: "TranscriptionQueue.enqueue"
      via: "queue.enqueue for each segment"
      pattern: "transcriptionQueue.*enqueue"
---

<objective>
Integrate VAD into AudioRecorder and add continuous dictation mode to TranscriptionService.

Purpose: Wire the infrastructure from Plan 01 into the existing audio pipeline. When auto-segment mode is enabled and silence is detected, segments are automatically queued for transcription while recording continues.

Output:
- SegmentMode enum (manual/auto with threshold)
- AudioRecorder with VAD integration and silence callback
- TranscriptionService with continuous mode and queue management
- AppState updated with VADService ownership
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.1-ROADMAP.md
@.planning/milestones/v1.1-REQUIREMENTS.md
@.planning/phases/06-auto-segment/06-RESEARCH.md
@.planning/phases/06-auto-segment/06-01-SUMMARY.md

# Files to modify
@LocalTranscript/LocalTranscript/Services/AudioRecorder.swift
@LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
@LocalTranscript/LocalTranscript/Models/AppState.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SegmentMode and integrate VAD into AudioRecorder</name>
  <files>
    LocalTranscript/LocalTranscript/Models/SegmentMode.swift
    LocalTranscript/LocalTranscript/Services/AudioRecorder.swift
  </files>
  <action>
1. Create SegmentMode.swift:
   - enum SegmentMode: String, CaseIterable
   - case manual = "Manual" (existing behavior - hotkey release triggers transcription)
   - case auto = "Auto-Segment" (VAD-triggered automatic segmentation)

2. Modify AudioRecorder.swift to add VAD integration:

   NEW properties:
   - private var circularBuffer: CircularAudioBuffer?
   - private var vadService: VADService?
   - private var vadState: VADState = .idle
   - private var silenceStartTime: Date?
   - var silenceThreshold: TimeInterval = 2.0 (user configurable, default 2s per SEG-01)
   - var onSilenceDetected: (([Float]) -> Void)? (callback when segment ready)
   - var isAutoSegmentEnabled: Bool = false

   NEW enum VADState:
   - case idle (not speaking)
   - case speech (voice detected)
   - case silencePending (silence started, waiting for threshold)

   MODIFY startRecording():
   - If isAutoSegmentEnabled:
     - Initialize circularBuffer with 60s capacity
     - Initialize vadService if not already (lazy, like ModelManager)
     - Reset vadState to .idle

   MODIFY processBuffer():
   - Always convert to 16kHz and store in circularBuffer (replaces accumulatedSamples when auto-segment)
   - If isAutoSegmentEnabled AND vadService.isInitialized:
     - Chunk the converted samples into 512-sample chunks
     - For each chunk, call vadService.processChunk()
     - Update vadState based on result:
       - idle + voice -> speech
       - speech + silence -> silencePending (record silenceStartTime)
       - silencePending + voice -> speech (cancel pending)
       - silencePending + silence > threshold -> extract segment, call onSilenceDetected, reset to idle
   - If NOT isAutoSegmentEnabled, continue using accumulatedSamples as before

   MODIFY stopRecording():
   - If isAutoSegmentEnabled:
     - Extract any remaining audio from circularBuffer
     - Return that + clear buffer
   - Else: return accumulatedSamples as before

   NEW method initializeVAD() async throws:
   - Call vadService.initialize() if not already initialized
   - For pre-warming VAD model when user enables auto-segment

IMPORTANT: Keep processBuffer() fast. VAD processing is ~1ms per chunk but don't block audio thread. Consider DispatchQueue.global().async for VAD calls if needed.
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -20`

AudioRecorder has VAD integration.
  </verify>
  <done>
- SegmentMode.swift created with manual/auto cases
- AudioRecorder.swift has circularBuffer, vadService, vadState properties
- processBuffer() chunks to 512 samples and processes through VAD when enabled
- onSilenceDetected callback triggers when silence > threshold
- Existing manual mode (accumulatedSamples) still works unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add continuous mode to TranscriptionService</name>
  <files>
    LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
    LocalTranscript/LocalTranscript/Models/AppState.swift
  </files>
  <action>
1. Modify TranscriptionService.swift:

   NEW properties:
   - private let transcriptionQueue = TranscriptionQueue()
   - private(set) var pendingSegments: Int = 0 (mirrors queue.pendingCount for UI)
   - @ObservationIgnored private var segmentMode: String { UserDefaults }
   - @ObservationIgnored private var silenceThreshold: Double { UserDefaults, default 2.0 }

   NEW TranscriptionState case:
   - case continuousRecording (recording with auto-segment active)

   NEW computed property:
   - var isContinuousMode: Bool { segmentMode == SegmentMode.auto.rawValue }

   NEW method startContinuousRecording() async throws:
   - Similar to startRecording() but:
     - Set audioRecorder.isAutoSegmentEnabled = true
     - Set audioRecorder.silenceThreshold = silenceThreshold
     - Set audioRecorder.onSilenceDetected = { [weak self] samples in self?.handleSegment(samples) }
     - State = .continuousRecording (not .recording)
     - Initialize VAD model if needed (show downloading state like Whisper model)

   NEW method handleSegment(_ samples: [Float]):
   - Called by AudioRecorder callback when silence detected
   - Show visual feedback (SEG-03) - brief indicator that segment was detected
   - Increment pendingSegments
   - Task { try await transcriptionQueue.enqueue { try await self.transcribe(samples) } }
   - On completion: decrement pendingSegments, insert text, save to history
   - Continue recording (don't change state)

   MODIFY stopRecording():
   - If state == .continuousRecording:
     - Get remaining samples from audioRecorder.stopRecording()
     - If samples not empty, queue final segment
     - Wait for all pending segments to complete (or provide option)
     - Reset audioRecorder.isAutoSegmentEnabled = false
     - State = .idle

   MODIFY startRecording():
   - Check if isContinuousMode -> call startContinuousRecording() instead

2. Modify AppState.swift:
   - Add VADService instance (lazy initialized like ModelManager)
   - Pass vadService to AudioRecorder or TranscriptionService as needed
   - Update setupHotkeyBindings to handle both modes properly
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -20`

TranscriptionService has continuous mode with queue.
  </verify>
  <done>
- TranscriptionService.swift has startContinuousRecording(), handleSegment() methods
- TranscriptionQueue used for FIFO segment processing
- pendingSegments property tracks queue depth for UI
- Segments transcribed and inserted independently while recording continues
- AppState owns VADService instance
- Both manual and auto-segment modes work from same hotkey trigger
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
```bash
xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | grep -E "(error:|BUILD SUCCEEDED)"
```

2. Integration check - AudioRecorder has VAD:
```bash
grep -E "VADService|onSilenceDetected|circularBuffer" LocalTranscript/LocalTranscript/Services/AudioRecorder.swift
```

3. Integration check - TranscriptionService has queue:
```bash
grep -E "TranscriptionQueue|pendingSegments|startContinuousRecording" LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
```
</verification>

<success_criteria>
- [ ] SegmentMode.swift created with manual/auto cases
- [ ] AudioRecorder integrates VADService and CircularAudioBuffer
- [ ] AudioRecorder calls onSilenceDetected when silence > threshold
- [ ] TranscriptionService has startContinuousRecording() for auto-segment mode
- [ ] TranscriptionService uses TranscriptionQueue for FIFO processing
- [ ] pendingSegments property available for UI (SEG-07)
- [ ] Manual mode (existing behavior) still works unchanged
- [ ] Project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-auto-segment/06-02-SUMMARY.md`
</output>
