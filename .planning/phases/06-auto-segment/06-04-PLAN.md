---
phase: 06-auto-segment
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "In Auto mode, transcribed segment text is inserted at cursor position"
    - "Status indicator transitions properly after segment transcription completes"
    - "Pending segments count visible during continuous recording"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Services/TranscriptionService.swift"
      provides: "Continuous recording with proper text insertion and status transitions"
      contains: "insertTextAtCursor|continuousRecording"
  key_links:
    - from: "handleSegment() transcription result"
      to: "insertTextAtCursor()"
      via: "direct await (not fire-and-forget Task)"
      pattern: "await self.insertTextAtCursor"
    - from: "handleSegment() completion"
      to: "showStatusPanel(.continuousRecording)"
      via: "state transition when queue empty"
      pattern: "showStatusPanel\\(.continuousRecording"
---

<objective>
Fix two bugs in auto-segment continuous recording mode that prevent text insertion and cause status indicator to get stuck.

Purpose: Close gaps identified in UAT Tests 3, 4, 5, and 6. The bugs are:
1. Fire-and-forget `Task { }` at lines 318-321 causes text insertion to race/not execute
2. Empty code block at lines 325-330 prevents status from transitioning back to continuousRecording

Output: Working continuous recording where text inserts at cursor and status indicator transitions correctly.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/milestones/v1.1-ROADMAP.md
@.planning/phases/06-auto-segment/06-UAT.md

# File to fix
@LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix text insertion and status transition in handleSegment()</name>
  <files>
    LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  </files>
  <action>
In the `handleSegment(_ samples:)` method, fix two bugs within the `MainActor.run` block (around lines 305-332):

**Bug 1: Fire-and-forget Task for text insertion (lines 318-321)**

Current code:
```swift
// Insert text
Task {
    await self.insertTextAtCursor(text)
}
```

Fix: Remove the `Task { }` wrapper and directly await the insertion. Since we're already inside `MainActor.run`, we can call `await` directly:
```swift
// Insert text
await self.insertTextAtCursor(text)
```

**Bug 2: Empty code block for status transition (lines 325-330)**

Current code:
```swift
if self.pendingSegments == 0 {
    if case .continuousRecording = self.state {
        // Still recording, keep status visible
    } else {
        self.hideStatusPanel()
    }
}
```

Fix: Add the missing state transition to show continuousRecording status:
```swift
if self.pendingSegments == 0 {
    if case .continuousRecording = self.state {
        // Return to continuous recording state (from .transcribing)
        self.showStatusPanel(.continuousRecording(pendingSegments: 0))
    } else {
        self.hideStatusPanel()
    }
}
```

These are the ONLY two changes needed. Do not modify any other code.
  </action>
  <verify>
1. Build succeeds:
```bash
xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -20
```

2. Verify the fixes are in place:
```bash
# Should NOT find "Task {" near insertTextAtCursor in handleSegment
grep -A5 "Insert text" LocalTranscript/LocalTranscript/Services/TranscriptionService.swift

# Should find showStatusPanel(.continuousRecording in the pendingSegments == 0 block
grep -B2 -A2 "continuousRecording = self.state" LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
```
  </verify>
  <done>
- handleSegment() directly awaits insertTextAtCursor() without fire-and-forget Task wrapper
- handleSegment() calls showStatusPanel(.continuousRecording(pendingSegments: 0)) when queue empties during continuous recording
- Project builds without errors
  </done>
</task>

</tasks>

<verification>
After task completes:

1. Build verification:
```bash
xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | grep -E "(error:|BUILD SUCCEEDED)"
```

2. Code verification - text insertion fix:
```bash
# The insertTextAtCursor call should be directly awaited, not wrapped in Task
grep -n "insertTextAtCursor" LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
```

3. Code verification - status transition fix:
```bash
# Should find showStatusPanel(.continuousRecording in handleSegment
grep -n "showStatusPanel.*continuousRecording" LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
```

4. Gap closure verification (all 4 UAT gaps addressed by these 2 fixes):
- Test 3: Text insertion works (fix 1)
- Test 4: Status transitions correctly (fix 2)
- Test 5: Pending count visible (fix 2)
- Test 6: Auto-insert works (fix 1)
</verification>

<success_criteria>
- [ ] Fire-and-forget Task removed from insertTextAtCursor call
- [ ] showStatusPanel(.continuousRecording(pendingSegments: 0)) added to empty block
- [ ] Project builds without errors
- [ ] No other code changes made (surgical fix)
</success_criteria>

<output>
After completion, create `.planning/phases/06-auto-segment/06-04-SUMMARY.md`
</output>
