---
phase: 06-auto-segment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - LocalTranscript/LocalTranscript/Services/VADService.swift
  - LocalTranscript/LocalTranscript/Services/CircularAudioBuffer.swift
  - LocalTranscript/LocalTranscript/Services/TranscriptionQueue.swift
  - LocalTranscript/LocalTranscript.xcodeproj/project.pbxproj
autonomous: true

must_haves:
  truths:
    - "VAD service can detect speech/silence from 16kHz audio chunks"
    - "Circular buffer can store up to 60s of audio without unbounded growth"
    - "Transcription queue processes segments sequentially in FIFO order"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Services/VADService.swift"
      provides: "SileroVAD wrapper via FluidAudio"
      exports: ["VADService", "VADResult"]
      min_lines: 50
    - path: "LocalTranscript/LocalTranscript/Services/CircularAudioBuffer.swift"
      provides: "Thread-safe circular buffer for Float samples"
      exports: ["CircularAudioBuffer"]
      min_lines: 40
    - path: "LocalTranscript/LocalTranscript/Services/TranscriptionQueue.swift"
      provides: "Actor-based FIFO queue with depth tracking"
      exports: ["TranscriptionQueue"]
      min_lines: 40
  key_links:
    - from: "VADService"
      to: "FluidAudio.VadManager"
      via: "import FluidAudio, VadModels.downloadAndLoad()"
      pattern: "VadManager|VadModels"
    - from: "TranscriptionQueue"
      to: "FIFOQueue"
      via: "import AsyncQueue"
      pattern: "FIFOQueue|Task\\(on:"
---

<objective>
Create core infrastructure for auto-segment feature: VAD service, circular audio buffer, and transcription queue actor.

Purpose: These three components are independent building blocks that Wave 2 will wire together into AudioRecorder and TranscriptionService.

Output:
- VADService.swift wrapping FluidAudio's SileroVAD
- CircularAudioBuffer.swift for bounded audio storage
- TranscriptionQueue.swift actor for FIFO segment processing
- SPM dependencies added (FluidAudio, swift-async-queue)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.1-ROADMAP.md
@.planning/milestones/v1.1-REQUIREMENTS.md
@.planning/phases/06-auto-segment/06-RESEARCH.md

# Existing patterns to follow
@LocalTranscript/LocalTranscript/Services/AudioRecorder.swift
@LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SPM dependencies and create VADService</name>
  <files>
    LocalTranscript/LocalTranscript.xcodeproj/project.pbxproj
    LocalTranscript/LocalTranscript/Services/VADService.swift
  </files>
  <action>
1. Add Swift Package dependencies to Xcode project:
   - FluidAudio from "https://github.com/FluidInference/FluidAudio.git" (from: "0.7.9")
   - swift-async-queue from "https://github.com/dfed/swift-async-queue" (from: "1.0.0")

2. Create VADService.swift with:
   - Import FluidAudio
   - VADResult struct: isVoiceActive (Bool), confidence (Float)
   - VADService class (NOT actor - needs to run on audio thread):
     - Private VadManager? instance
     - isInitialized: Bool property
     - initialize() async throws -> downloads and loads VAD model
     - processChunk(_ samples: [Float]) throws -> VADResult
       - CRITICAL: Must receive exactly 512 samples at 16kHz (32ms chunks)
       - If samples.count != 512, throw VADError.invalidChunkSize
     - reset() -> clears VAD internal state for new utterance
   - VADError enum: notInitialized, invalidChunkSize, processingFailed

Note: FluidAudio API may be complex per research. If VadManager API differs from expected, adapt accordingly but maintain the 512-sample chunk requirement.
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -20`

VADService file exists with expected exports.
  </verify>
  <done>
- FluidAudio and swift-async-queue packages added to project
- VADService.swift compiles with initialize(), processChunk(), reset() methods
- VADResult struct defined with isVoiceActive and confidence
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CircularAudioBuffer and TranscriptionQueue</name>
  <files>
    LocalTranscript/LocalTranscript/Services/CircularAudioBuffer.swift
    LocalTranscript/LocalTranscript/Services/TranscriptionQueue.swift
  </files>
  <action>
1. Create CircularAudioBuffer.swift:
   - Thread-safe circular buffer for Float samples
   - init(capacity: Int) - default 60 seconds at 16kHz = 960,000 samples
   - write(_ samples: [Float]) - append samples, overwrite oldest if full
   - read(count: Int) -> [Float] - read most recent N samples without removing
   - extract() -> [Float] - read all available samples AND clear buffer
   - extractAndKeep(keepLast: Int) -> [Float] - extract but keep last N samples (for overlap)
   - var availableCount: Int - how many samples currently stored
   - Use NSLock for thread safety (audio thread writes, main thread reads)

2. Create TranscriptionQueue.swift:
   - Import AsyncQueue
   - actor TranscriptionQueue:
     - private let queue = FIFOQueue()
     - private(set) var pendingCount: Int = 0
     - var isEmpty: Bool { pendingCount == 0 }
     - enqueue(_ operation: @escaping () async throws -> String) async throws -> String
       - Increment pendingCount before, decrement after
       - Execute operation on FIFOQueue to ensure sequential processing
       - Return transcription result
     - If swift-async-queue API differs, implement manual FIFO using Task + actor isolation

Note: TranscriptionQueue is intentionally generic (takes closure) so it can be wired to different transcription methods later.
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -20`

Files exist with expected structure.
  </verify>
  <done>
- CircularAudioBuffer.swift with write/read/extract methods and NSLock thread safety
- TranscriptionQueue.swift actor with pendingCount tracking and FIFO ordering
- Both compile successfully with existing codebase
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
```bash
xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | grep -E "(error:|BUILD SUCCEEDED)"
```

2. File structure verification:
```bash
ls -la LocalTranscript/LocalTranscript/Services/*.swift | grep -E "(VADService|CircularAudioBuffer|TranscriptionQueue)"
```

3. Dependency verification:
```bash
grep -l "FluidAudio\|AsyncQueue" LocalTranscript/LocalTranscript.xcodeproj/project.pbxproj
```
</verification>

<success_criteria>
- [ ] FluidAudio and swift-async-queue SPM packages added
- [ ] VADService.swift exists with initialize(), processChunk(512 samples), reset()
- [ ] CircularAudioBuffer.swift exists with thread-safe write/read/extract
- [ ] TranscriptionQueue.swift exists as actor with pendingCount and FIFO ordering
- [ ] Project builds without errors
- [ ] All three files follow existing @Observable/@ObservationIgnored patterns where appropriate
</success_criteria>

<output>
After completion, create `.planning/phases/06-auto-segment/06-01-SUMMARY.md`
</output>
