---
phase: 06-auto-segment
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - LocalTranscript/LocalTranscript/Views/SettingsView.swift
  - LocalTranscript/LocalTranscript/Models/StatusIndicatorState.swift
  - LocalTranscript/LocalTranscript/Views/StatusIndicatorPanel.swift
autonomous: false

must_haves:
  truths:
    - "User can enable auto-segment mode in Settings"
    - "User can configure silence threshold 1-5 seconds in Settings"
    - "Visual indicator shows when segment boundary is detected"
    - "Visual indicator shows pending segment count during continuous recording"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Views/SettingsView.swift"
      provides: "Auto-segment settings section"
      contains: "SegmentMode|silenceThreshold"
      min_lines: 200
    - path: "LocalTranscript/LocalTranscript/Models/StatusIndicatorState.swift"
      provides: "New states for segment detection and queue depth"
      contains: "segmentDetected|continuousRecording"
      min_lines: 30
    - path: "LocalTranscript/LocalTranscript/Views/StatusIndicatorPanel.swift"
      provides: "UI for new status states"
      contains: "segmentDetected|pendingSegments"
  key_links:
    - from: "SettingsView segmentMode"
      to: "UserDefaults segmentMode"
      via: "@AppStorage binding"
      pattern: "@AppStorage.*segmentMode"
    - from: "SettingsView silenceThreshold"
      to: "UserDefaults silenceThreshold"
      via: "@AppStorage binding"
      pattern: "@AppStorage.*silenceThreshold"
    - from: "StatusIndicatorPanel"
      to: "StatusIndicatorState"
      via: "switch on state cases"
      pattern: "case .segmentDetected|case .continuousRecording"
---

<objective>
Add Settings UI for auto-segment configuration and visual indicators for segment detection and queue depth.

Purpose: Complete the user-facing features: ability to configure auto-segment mode and threshold, visual feedback when segments are detected, and queue depth indicator showing how many segments are pending.

Output:
- Settings section for auto-segment (toggle + threshold slider)
- StatusIndicatorState with new cases for segment feedback
- StatusIndicatorPanel updated to render new states
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.1-ROADMAP.md
@.planning/milestones/v1.1-REQUIREMENTS.md
@.planning/phases/06-auto-segment/06-RESEARCH.md
@.planning/phases/06-auto-segment/06-02-SUMMARY.md

# Files to modify
@LocalTranscript/LocalTranscript/Views/SettingsView.swift
@LocalTranscript/LocalTranscript/Models/StatusIndicatorState.swift
@LocalTranscript/LocalTranscript/Views/StatusIndicatorPanel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-segment settings section</name>
  <files>
    LocalTranscript/LocalTranscript/Views/SettingsView.swift
  </files>
  <action>
1. Add new @AppStorage properties:
   - @AppStorage("segmentMode") private var segmentMode = SegmentMode.manual.rawValue
   - @AppStorage("silenceThreshold") private var silenceThreshold: Double = 2.0

2. Add new "Auto-Segment" section in generalTab, AFTER the "Hotkey" section:

   Section("Auto-Segment") {
     // Mode picker (Manual vs Auto)
     Picker("Mode", selection: $segmentMode) {
       ForEach(SegmentMode.allCases, id: \.self) { mode in
         Text(mode.rawValue).tag(mode.rawValue)
       }
     }
     .pickerStyle(.segmented)

     // Silence threshold slider (only shown when Auto selected)
     if segmentMode == SegmentMode.auto.rawValue {
       VStack(alignment: .leading, spacing: 4) {
         HStack {
           Text("Silence Threshold")
           Spacer()
           Text(String(format: "%.1fs", silenceThreshold))
             .foregroundStyle(.secondary)
         }
         Slider(value: $silenceThreshold, in: 1.0...5.0, step: 0.5)
       }

       Text("Time of silence before auto-inserting text. Shorter = faster insertion, longer = fewer interruptions.")
         .font(.caption)
         .foregroundStyle(.secondary)
     }

     // Mode description
     Text(segmentModeDescription)
       .font(.caption)
       .foregroundStyle(.secondary)
   }

3. Add computed property segmentModeDescription:
   - Manual: "Standard mode. Hold hotkey to record, release to transcribe."
   - Auto: "Continuous dictation. Text automatically inserts when you pause speaking."
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -20`

Settings has auto-segment section.
  </verify>
  <done>
- SettingsView.swift has "Auto-Segment" section with mode picker
- Silence threshold slider shows when Auto mode selected (1-5 seconds)
- @AppStorage bindings store segmentMode and silenceThreshold in UserDefaults
- Descriptive text explains each mode
  </done>
</task>

<task type="auto">
  <name>Task 2: Add visual indicators for segment detection and queue</name>
  <files>
    LocalTranscript/LocalTranscript/Models/StatusIndicatorState.swift
    LocalTranscript/LocalTranscript/Views/StatusIndicatorPanel.swift
  </files>
  <action>
1. Modify StatusIndicatorState.swift - add new cases:

   /// Recording in continuous/auto-segment mode (shows queue depth)
   case continuousRecording(pendingSegments: Int)

   /// Brief flash when segment boundary detected (before transcription starts)
   case segmentDetected

   Update autoDismissDelay:
   - .continuousRecording: nil (stays visible during recording)
   - .segmentDetected: 0.5 (very brief flash, 500ms)

2. Modify StatusIndicatorPanel.swift - update contentView for new states:

   For .continuousRecording(let pending):
   - Show microphone icon (like recording)
   - Add text: "Recording..." if pending == 0
   - Add text: "Recording... (X pending)" if pending > 0
   - Use different color or badge to indicate queue depth
   - Example: Blue mic icon + "Recording... (2 pending)" in smaller text

   For .segmentDetected:
   - Show brief checkmark or segment icon
   - Text: "Segment detected"
   - Green/success color
   - Auto-dismisses quickly (0.5s) then returns to .continuousRecording

3. Ensure smooth state transitions:
   - continuousRecording -> segmentDetected -> continuousRecording
   - The panel should flash briefly for segment detection without closing

Note: StatusIndicatorPanel is NSPanel subclass. Check existing implementation for how to update content view. May need to handle state transitions gracefully.
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -20`

New states added to StatusIndicatorState.
  </verify>
  <done>
- StatusIndicatorState.swift has .continuousRecording(pendingSegments:) case
- StatusIndicatorState.swift has .segmentDetected case for brief visual flash
- StatusIndicatorPanel.swift renders both new states appropriately
- Queue depth visible during continuous recording (SEG-07)
- Segment detection shows brief visual feedback (SEG-03)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete auto-segment feature: VAD-based silence detection, transcription queue, settings UI, and visual indicators</what-built>
  <how-to-verify>
1. Build and run the app:
   xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build && open ~/Library/Developer/Xcode/DerivedData/LocalTranscript-*/Build/Products/Debug/LocalTranscript.app

2. Open Settings (click menu bar icon -> Settings):
   - Verify "Auto-Segment" section appears after "Hotkey" section
   - Select "Auto-Segment" mode
   - Verify silence threshold slider appears (1-5 seconds range)
   - Set threshold to 2.0 seconds

3. Test continuous recording:
   - Hold Option+Space to start recording
   - Speak a sentence, then pause for 2+ seconds
   - Verify visual indicator shows "Segment detected" briefly
   - Continue speaking another sentence
   - Release hotkey
   - Verify both sentences were transcribed and inserted

4. Test queue indicator:
   - Speak quickly with short pauses to queue multiple segments
   - Verify "(X pending)" shows in status indicator during processing

5. Test manual mode still works:
   - Switch back to "Manual" mode in Settings
   - Verify normal hold-to-talk behavior unchanged
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
```bash
xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | grep -E "(error:|BUILD SUCCEEDED)"
```

2. Settings section check:
```bash
grep -E "Auto-Segment|segmentMode|silenceThreshold" LocalTranscript/LocalTranscript/Views/SettingsView.swift
```

3. Status state check:
```bash
grep -E "continuousRecording|segmentDetected" LocalTranscript/LocalTranscript/Models/StatusIndicatorState.swift
```

4. Full requirements coverage:
- SEG-01: Toggle mode auto-inserts on silence (via SegmentMode + VAD pipeline)
- SEG-02: Silence threshold configurable 1-5s (via Settings slider)
- SEG-03: Visual feedback on segment detection (via .segmentDetected state)
- SEG-04: SileroVAD neural detection (via FluidAudio VADService)
- SEG-05: Buffer continues during transcription (via CircularAudioBuffer + continuous mode)
- SEG-06: Queue management for pending segments (via TranscriptionQueue actor)
- SEG-07: Visual indicator shows pending count (via .continuousRecording(pendingSegments:))
</verification>

<success_criteria>
- [ ] SettingsView has "Auto-Segment" section with mode picker and threshold slider
- [ ] Threshold slider range is 1-5 seconds with 0.5s step
- [ ] Settings persist via @AppStorage/UserDefaults
- [ ] StatusIndicatorState has .continuousRecording(pendingSegments:) case
- [ ] StatusIndicatorState has .segmentDetected case
- [ ] StatusIndicatorPanel renders both new states with appropriate visuals
- [ ] Project builds without errors
- [ ] Human verification confirms end-to-end auto-segment flow works
</success_criteria>

<output>
After completion, create `.planning/phases/06-auto-segment/06-03-SUMMARY.md`
</output>
