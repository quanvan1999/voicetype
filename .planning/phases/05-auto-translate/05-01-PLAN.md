---
phase: 05-auto-translate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - LocalTranscript/LocalTranscript/Views/SettingsView.swift
  - LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
  - LocalTranscript/LocalTranscript/Models/TranscriptionRecord.swift
  - LocalTranscript/LocalTranscript/Services/HistoryManager.swift
  - LocalTranscript/LocalTranscript/Views/HistoryView.swift
autonomous: true

must_haves:
  truths:
    - "User can toggle translate mode on/off in Settings"
    - "When translate mode is on, Vietnamese speech produces English text"
    - "Translation works without internet connection"
    - "Translated transcriptions are marked in history"
  artifacts:
    - path: "LocalTranscript/LocalTranscript/Views/SettingsView.swift"
      provides: "Translate toggle UI"
      contains: "@AppStorage(\"translateMode\")"
    - path: "LocalTranscript/LocalTranscript/Services/TranscriptionService.swift"
      provides: "Translate task selection"
      contains: "task: translateMode ? .translate : .transcribe"
    - path: "LocalTranscript/LocalTranscript/Models/TranscriptionRecord.swift"
      provides: "Translated flag storage"
      contains: "var wasTranslated: Bool"
  key_links:
    - from: "SettingsView.swift"
      to: "UserDefaults"
      via: "@AppStorage translateMode binding"
      pattern: "@AppStorage.*translateMode"
    - from: "TranscriptionService.swift"
      to: "WhisperKit"
      via: "DecodingOptions task parameter"
      pattern: "task:.*\\.translate"
---

<objective>
Implement auto-translate feature: user speaks Vietnamese, receives English text output.

Purpose: Enable bilingual users to dictate in Vietnamese and get English text for use in English-language contexts (emails, documents, code comments). Uses WhisperKit's built-in `.translate` task for single-inference translation with no additional latency.

Output: Working translate mode toggle in Settings, functional Vietnamese-to-English translation, history tracking of translated entries.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/milestones/v1.1-ROADMAP.md
@.planning/milestones/v1.1-REQUIREMENTS.md
@.planning/phases/05-auto-translate/05-RESEARCH.md

# Existing code patterns
@LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
@LocalTranscript/LocalTranscript/Views/SettingsView.swift
@LocalTranscript/LocalTranscript/Models/LanguageMode.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add translate toggle to Settings</name>
  <files>LocalTranscript/LocalTranscript/Views/SettingsView.swift</files>
  <action>
Add a "Translation" section to SettingsView after the "Language" section:

1. Add @AppStorage property:
   ```swift
   @AppStorage("translateMode") private var translateMode = false
   ```

2. Add new Section after Language section:
   ```swift
   Section("Translation") {
       Toggle("Translate to English", isOn: $translateMode)

       Text("When enabled, Vietnamese speech will be translated to English text. Works offline using Whisper's built-in translation.")
           .font(.caption)
           .foregroundStyle(.secondary)
   }
   ```

3. Place the Translation section between "Language" and "Model" sections to group language-related settings together.

Note: Do NOT add any conditional logic to disable the toggle when language is English - that complexity is deferred. Let users experiment with translate mode in any language configuration.
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -5`

Visual check: Open Settings, verify "Translation" section appears with toggle and explanation text.
  </verify>
  <done>
- Translation section visible in Settings between Language and Model
- Toggle labeled "Translate to English"
- Explanation text describes offline Whisper translation
- Toggle state persists across app restarts
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement translate task selection in TranscriptionService</name>
  <files>LocalTranscript/LocalTranscript/Services/TranscriptionService.swift</files>
  <action>
Modify TranscriptionService to use WhisperKit's `.translate` task when translate mode is enabled:

1. Add translateMode property following existing languageMode pattern (around line 23-26):
   ```swift
   @ObservationIgnored
   private var translateMode: Bool {
       get { UserDefaults.standard.bool(forKey: "translateMode") }
       set { UserDefaults.standard.set(newValue, forKey: "translateMode") }
   }
   ```

2. Modify the `transcribe(samples:)` method to select task based on translateMode:
   - After getting `whisperLanguage` (around line 201), add:
     ```swift
     let task: DecodingTask = translateMode ? .translate : .transcribe
     print("[Transcribe] Translate mode: \(translateMode), task: \(task)")
     ```
   - Update DecodingOptions to use the task variable:
     ```swift
     let options = DecodingOptions(
         task: task,  // Changed from hardcoded .transcribe
         language: whisperLanguage,
         // ... rest unchanged
     )
     ```

3. Return the translateMode value for history tracking (modify signature and return):
   - This will be used in Task 3. For now, just ensure translateMode is accessible.
   - Add a computed property to expose translateMode for the history save call:
     ```swift
     var isTranslateEnabled: Bool { translateMode }
     ```
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -5`

Functional test:
1. Run app, enable translate mode in Settings
2. Hold hotkey, speak Vietnamese phrase (e.g., "Xin chao")
3. Verify English output appears (e.g., "Hello")
4. Check console for `[Transcribe] Translate mode: true, task: translate`
  </verify>
  <done>
- TranscriptionService reads translateMode from UserDefaults
- When translateMode=true, WhisperKit uses DecodingTask.translate
- When translateMode=false, WhisperKit uses DecodingTask.transcribe
- Console logging shows task selection
  </done>
</task>

<task type="auto">
  <name>Task 3: Track translated flag in history</name>
  <files>
LocalTranscript/LocalTranscript/Models/TranscriptionRecord.swift
LocalTranscript/LocalTranscript/Services/HistoryManager.swift
LocalTranscript/LocalTranscript/Services/TranscriptionService.swift
LocalTranscript/LocalTranscript/Views/HistoryView.swift
  </files>
  <action>
Add tracking of whether a transcription was translated, with visual indicator in history:

1. **TranscriptionRecord.swift** - Add wasTranslated property:
   ```swift
   var wasTranslated: Bool

   init(text: String, languageMode: String, duration: TimeInterval, wasTranslated: Bool = false) {
       self.id = UUID()
       self.text = text
       self.timestamp = Date()
       self.languageMode = languageMode
       self.duration = duration
       self.wasTranslated = wasTranslated
   }
   ```

2. **HistoryManager.swift** - Update save method signature:
   ```swift
   func save(text: String, languageMode: String, duration: TimeInterval, wasTranslated: Bool = false) {
       guard let context = modelContext else { return }
       let record = TranscriptionRecord(text: text, languageMode: languageMode, duration: duration, wasTranslated: wasTranslated)
       // ... rest unchanged
   }
   ```

3. **TranscriptionService.swift** - Pass translateMode to history save:
   In stopRecording(), update the historyManager.save call (around line 142):
   ```swift
   historyManager.save(
       text: text,
       languageMode: mode.rawValue,
       duration: duration,
       wasTranslated: isTranslateEnabled
   )
   ```

4. **HistoryView.swift** - Add visual indicator for translated entries:
   Find the row display code and add a translation badge/icon:
   ```swift
   // After the existing language badge, add:
   if record.wasTranslated {
       Text("EN")
           .font(.caption2)
           .foregroundStyle(.white)
           .padding(.horizontal, 4)
           .padding(.vertical, 2)
           .background(Color.blue)
           .clipShape(Capsule())
   }
   ```

Note: SwiftData migration - since this is a new property with a default value, existing records will get wasTranslated=false automatically. No explicit migration needed.
  </action>
  <verify>
Build succeeds: `xcodebuild -project LocalTranscript/LocalTranscript.xcodeproj -scheme LocalTranscript -configuration Debug build 2>&1 | tail -5`

Functional test:
1. Enable translate mode, make a transcription
2. Open History tab
3. Verify new entry shows "EN" badge
4. Disable translate mode, make another transcription
5. Verify new entry does NOT show "EN" badge
  </verify>
  <done>
- TranscriptionRecord has wasTranslated: Bool property
- History saves wasTranslated flag based on translate mode at transcription time
- HistoryView shows visual indicator (blue "EN" badge) for translated entries
- Existing history entries show no badge (wasTranslated defaults to false)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Settings UI:**
   - Open Settings window
   - Translation section visible with toggle and explanation
   - Toggle state persists after app restart

2. **Translation functionality:**
   - Enable translate mode
   - Speak Vietnamese phrase (e.g., "Xin chao, toi la mot chuong trinh")
   - English text output appears at cursor (e.g., "Hello, I am a program")
   - Works without internet (disconnect WiFi, verify still works)

3. **History tracking:**
   - History shows "EN" badge on translated entries
   - Non-translated entries have no badge
   - Both old (pre-update) and new entries display correctly

4. **No regression:**
   - Disable translate mode
   - Vietnamese speech produces Vietnamese text
   - English speech produces English text
   - All existing functionality unchanged
</verification>

<success_criteria>
- [ ] TRANS-01: Toggle visible in Settings, persists state
- [ ] TRANS-02: Vietnamese speech -> English text when toggle enabled
- [ ] TRANS-03: Works offline (Whisper translate is local, no network)
- [ ] TRANS-04: Uses WhisperKit DecodingTask.translate (single inference)
- [ ] History shows translated entries with visual indicator
- [ ] No regression in transcription-only mode
</success_criteria>

<output>
After completion, create `.planning/phases/05-auto-translate/05-01-SUMMARY.md`
</output>
